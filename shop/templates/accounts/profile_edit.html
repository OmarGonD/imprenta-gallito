{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="profile-edit-body py-10">
    <div class="container mx-auto px-4 max-w-4xl">
        <div class="glass-card overflow-hidden">
            <!-- Header Section -->
            <div class="edit-header p-8 text-center text-white relative h-48 flex flex-col items-center justify-center">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-700 opacity-90"></div>
                <!-- Dynamic Pattern Overlay (subtle) -->
                <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0); background-size: 24px 24px;"></div>
                
                <h1 class="text-3xl font-extrabold relative z-10 mb-2">Actualizar Perfil</h1>
                <p class="text-blue-100 relative z-10 font-medium">Mantén tu información al día para una mejor experiencia</p>
            </div>

            <form method="post" enctype="multipart/form-data" class="p-8 md:p-12">
                {% csrf_token %}

                <div class="grid lg:grid-cols-3 gap-12">
                    <!-- Left Column: Avatar -->
                    <div class="lg:col-span-1 flex flex-col items-center">
                        <div class="relative group">
                            <div class="w-48 h-48 rounded-full overflow-hidden border-4 border-white shadow-2xl relative bg-gray-100 flex items-center justify-center">
                                {% if profile.photo and 'default' not in profile.photo.name %}
                                    <img src="{{ profile.photo.url }}" alt="Profile Photo" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" id="profile-preview">
                                    <div id="profile-icon-placeholder" class="hidden">
                                        <i class="fas fa-user text-6xl text-gray-300"></i>
                                    </div>
                                {% else %}
                                    <img src="" alt="Profile Photo" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 hidden" id="profile-preview">
                                    <div id="profile-icon-placeholder">
                                        <i class="fas fa-user text-6xl text-gray-300"></i>
                                    </div>
                                {% endif %}
                                
                                <!-- Hover Overlay -->
                                <label for="{{ profile_form.photo.id_for_label }}" class="absolute inset-0 bg-black bg-opacity-40 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-300">
                                    <i class="fas fa-camera text-white text-3xl mb-2"></i>
                                    <span class="text-white text-xs font-bold uppercase tracking-wider">Cambiar Foto</span>
                                </label>
                            </div>
                            
                            <!-- Hidden File Input -->
                            <div class="hidden">
                                {{ profile_form.photo }}
                            </div>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <h3 class="font-bold text-gray-800 text-lg">{{ user.username }}</h3>
                            <p class="text-gray-500 text-sm">{{ user.email }}</p>
                        </div>
                        
                        <!-- Completeness Badge -->
                        <div class="mt-6 w-full p-4 rounded-xl {% if profile.is_complete %}bg-emerald-50 border border-emerald-100 text-emerald-700{% else %}bg-amber-50 border border-amber-100 text-amber-700{% endif %} flex flex-col items-center gap-2">
                            <span class="text-xs font-bold uppercase tracking-widest">Estado de Perfil</span>
                            <div class="flex items-center gap-2 font-bold">
                                {% if profile.is_complete %}
                                    <i class="fas fa-check-circle"></i> Completo
                                {% else %}
                                    <i class="fas fa-exclamation-circle"></i> Incompleto
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Form Fields -->
                    <div class="lg:col-span-2 space-y-10">
                        
                        <!-- Section: Personal -->
                        <div class="form-section">
                            <h2 class="section-title"><i class="fas fa-user-tag mr-3"></i>Información Personal</h2>
                            <div class="grid md:grid-cols-2 gap-6 mt-6">
                                <div class="input-group">
                                    <label class="input-label">Número de DNI</label>
                                    {{ profile_form.dni }}
                                    {% if profile_form.dni.errors %}
                                        <p class="error-msg">{{ profile_form.dni.errors|striptags }}</p>
                                    {% endif %}
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Fecha de Nacimiento</label>
                                    {{ profile_form.birthdate }}
                                    {% if profile_form.birthdate.errors %}
                                        <p class="error-msg">{{ profile_form.birthdate.errors|striptags }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mt-6">
                                <div class="input-group">
                                    <label class="input-label">Género / Sexo</label>
                                    <div class="gender-radio-grid">
                                        {{ profile_form.gender }}
                                    </div>
                                    {% if profile_form.gender.errors %}
                                        <p class="error-msg">{{ profile_form.gender.errors|striptags }}</p>
                                    {% endif %}
                                </div>
                                <div class="input-group">
                                    <label class="input-label">Celular / Teléfono</label>
                                    {{ profile_form.phone_number }}
                                    {% if profile_form.phone_number.errors %}
                                        <p class="error-msg">{{ profile_form.phone_number.errors|striptags }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Section: Shipping -->
                        <div class="form-section pt-4">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="section-title mb-0"><i class="fas fa-truck mr-3"></i>Datos de Envío</h2>
                                <span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-tighter">Obligatorio</span>
                            </div>
                            
                            <div class="space-y-6">
                                <div class="input-group">
                                    <label class="input-label">Dirección Exacta</label>
                                    {{ profile_form.shipping_address1 }}
                                    <p class="helper-text">Calle, número, urbanización o edificio.</p>
                                    {% if profile_form.shipping_address1.errors %}
                                        <p class="error-msg">{{ profile_form.shipping_address1.errors|striptags }}</p>
                                    {% endif %}
                                </div>

                                <div class="input-group">
                                    <label class="input-label">Punto de Referencia</label>
                                    {{ profile_form.reference }}
                                    <p class="helper-text">Ej: Frente al parque, cerca a la tienda X.</p>
                                    {% if profile_form.reference.errors %}
                                        <p class="error-msg">{{ profile_form.reference.errors|striptags }}</p>
                                    {% endif %}
                                </div>

                                <div class="grid md:grid-cols-3 gap-4 mt-6">
                                    <div class="input-group">
                                        <label class="input-label text-xs">Departamento</label>
                                        {{ profile_form.shipping_department }}
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label text-xs">Provincia</label>
                                        {{ profile_form.shipping_province }}
                                    </div>
                                    <div class="input-group">
                                        <label class="input-label text-xs">Distrito</label>
                                        {{ profile_form.shipping_district }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Area -->
                        <div class="flex flex-col md:flex-row gap-4 pt-8 border-t border-gray-100">
                            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <i class="fas fa-save"></i>
                                Guardar Cambios
                            </button>
                            <a href="{% url 'shop:profile' %}" class="px-8 py-4 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold rounded-xl transition-all text-center">
                                Cancelar
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    /* Premium Look Overrides */
    
    .profile-edit-body {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        min-height: 100vh;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 2rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
    }

    .section-title {
        font-size: 1.125rem;
        font-weight: 800;
        color: #1e293b;
        border-left: 4px solid #2563eb;
        padding-left: 1rem;
        margin-bottom: 0.5rem;
    }

    .input-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    /* Target Django autogenerated inputs */
    .input-group input, 
    .input-group select, 
    .input-group textarea {
        width: 100%;
        padding: 0.875rem 1rem;
        border-radius: 0.75rem;
        border: 1.5px solid #e2e8f0;
        background-color: #fbfcfd;
        color: #1e293b;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .input-group input:focus, 
    .input-group select:focus {
        outline: none;
        border-color: #3b82f6;
        background-color: #fff;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
    }

    .helper-text {
        font-size: 0.7rem;
        color: #94a3b8;
        margin-top: 0.4rem;
        margin-left: 0.2rem;
    }

    .error-msg {
        color: #ef4444;
        font-size: 0.75rem;
        font-weight: 600;
        margin-top: 0.4rem;
    }

    /* Gender Radio Custom Styling */
    .gender-radio-grid ul {
        display: flex;
        gap: 1.5rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .gender-radio-grid label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        color: #475569;
        font-size: 0.9rem;
    }

    .gender-radio-grid input[type="radio"] {
        width: 1.25rem;
        height: 1.25rem;
        cursor: pointer;
    }

    /* Date Select Grid */
    .input-group select {
        display: inline-block;
        width: auto;
        min-width: 80px;
        margin-right: 0.5rem;
    }

    /* Animation */
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .glass-card {
        animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Real-time photo preview
    $(document).on('change', '#id_photo', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#profile-preview').attr('src', e.target.result).removeClass('hidden');
                $('#profile-icon-placeholder').addClass('hidden');
            }
            reader.readAsDataURL(file);
        }
    });

    // Dynamic Cascading Selects (Province & District)
    async function get_provinces() {
        const val_d = $("#id_shipping_department").val();
        if(!val_d) return;
        
        $("#id_shipping_province").addClass('opacity-50 pointer-events-none');
        try {
            const result = await $.ajax({
                url: "/province/",
                data: { d_name: val_d },
            });
            $("#id_shipping_province").html(result).removeClass('opacity-50 pointer-events-none');
        } catch (e) {
            console.error("Error loading provinces", e);
        }
    }

    async function get_districts() {
        const val_d = $("#id_shipping_department").val();
        const val_p = $("#id_shipping_province").val();
        if(!val_d || !val_p) return;

        $("#id_shipping_district").addClass('opacity-50 pointer-events-none');
        try {
            const result = await $.ajax({
                url: "/district/",
                data: { d_name: val_d, p_name: val_p },
            });
            $("#id_shipping_district").html(result).removeClass('opacity-50 pointer-events-none');
        } catch (e) {
            console.error("Error loading districts", e);
        }
    }

    $(document).ready(function() {
        // Handle change events
        $("#id_shipping_department").change(async function() {
            await get_provinces();
            await get_districts();
        });

        $("#id_shipping_province").change(async function() {
            await get_districts();
        });

        // Add some tailwind-like transitions with jQuery if needed
        $('input, select, textarea').on('focus', function() {
            $(this).closest('.input-group').find('.input-label').addClass('text-blue-600');
        }).on('blur', function() {
            $(this).closest('.input-group').find('.input-label').removeClass('text-blue-600');
        });
    });
</script>
{% endblock %}
