{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - {{ product.category.name }} - Imprenta Gallito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/catalog.css' %}">
<link rel="stylesheet" href="{% static 'css/product-configurator.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'catalog:home' %}">Catálogo</a></li>
                <li class="breadcrumb-item"><a href="{% url 'catalog:category' product.category.slug %}">{{ product.category.name }}</a></li>
                {% if product.subcategory %}
                <li class="breadcrumb-item"><a href="{% url 'catalog:subcategory' product.category.slug product.subcategory.slug %}">{{ product.subcategory.name }}</a></li>
                {% endif %}
                <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- Product Images -->
            <div class="col-lg-5 col-md-6">
                <div class="product-images-section">
                    <div class="main-image">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" id="mainProductImage">
                        {% else %}
                        <div class="image-placeholder">
                            <i class="fas fa-image"></i>
                            <p>Imagen no disponible</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Thumbnails if multiple images exist -->
                    {% if product.additional_images %}
                    <div class="image-thumbnails">
                        <div class="thumbnail active">
                            <img src="{{ product.image.url }}" alt="{{ product.name }}">
                        </div>
                        {% for img in product.additional_images %}
                        <div class="thumbnail">
                            <img src="{{ img.url }}" alt="{{ product.name }}">
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Info & Configurator -->
            <div class="col-lg-7 col-md-6">
                <div class="product-info-section">
                    <h1 class="product-title">{{ product.name }}</h1>
                    
                    <div class="product-meta">
                        <span class="product-sku">SKU: {{ product.sku }}</span>
                        {% if product.subcategory %}
                        <span class="product-category">
                            <i class="fas fa-tag"></i> {{ product.category.name }} > {{ product.subcategory.name }}
                        </span>
                        {% endif %}
                    </div>

                    {% if product.description %}
                    <div class="product-description">
                        {{ product.description|linebreaks }}
                    </div>
                    {% endif %}

                    <!-- Product Configurator -->
                    <div class="product-configurator" id="productConfigurator">
                        <h3 class="configurator-title">Personaliza tu producto</h3>
                        
                        <!-- Quantity Selector -->
                        <div class="config-group quantity-group">
                            <label class="config-label">
                                <i class="fas fa-calculator"></i> Cantidad
                                <span class="required">*</span>
                            </label>
                            <div class="quantity-selector">
                                <button type="button" class="qty-btn qty-decrease" id="qtyDecrease">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="qty-input" id="quantityInput" 
                                       value="{{ default_quantity }}" 
                                       min="{{ price_tiers.0.min_quantity }}" 
                                       step="1">
                                <button type="button" class="qty-btn qty-increase" id="qtyIncrease">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Cantidad mínima: {{ price_tiers.0.min_quantity }}
                            </small>
                        </div>

                        <!-- Price Tiers Info -->
                        {% if price_tiers|length > 1 %}
                        <div class="price-tiers-info">
                            <p class="tiers-title"><i class="fas fa-info-circle"></i> Precios por volumen:</p>
                            <div class="tiers-list">
                                {% for tier in price_tiers %}
                                <div class="tier-item" data-min="{{ tier.min_quantity }}" data-max="{{ tier.max_quantity }}">
                                    <span class="tier-range">
                                        {% if tier.max_quantity %}
                                        {{ tier.min_quantity }} - {{ tier.max_quantity }} unidades
                                        {% else %}
                                        {{ tier.min_quantity }}+ unidades
                                        {% endif %}
                                    </span>
                                    <span class="tier-price">S/ {{ tier.price_per_unit }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Variant Options -->
                        {% for variant in variants %}
                        <div class="config-group variant-group" data-variant-id="{{ variant.id }}">
                            <label class="config-label">
                                <i class="fas {{ variant.icon|default:'fa-cog' }}"></i> 
                                {{ variant.name }}
                                {% if variant.is_required %}<span class="required">*</span>{% endif %}
                            </label>
                            
                            {% if variant.description %}
                            <p class="variant-description">{{ variant.description }}</p>
                            {% endif %}

                            <div class="variant-options">
                                {% for option in variant.options %}
                                <label class="variant-option {% if option.is_default %}selected{% endif %}">
                                    <input type="radio" 
                                           name="variant_{{ variant.id }}" 
                                           value="{{ option.id }}"
                                           data-variant-type="{{ variant.id }}"
                                           data-option-id="{{ option.id }}"
                                           data-additional-cost="{{ option.additional_cost }}"
                                           {% if option.is_default %}checked{% endif %}
                                           {% if variant.is_required %}required{% endif %}>
                                    <span class="option-content">
                                        <span class="option-name">{{ option.value }}</span>
                                        {% if option.additional_cost > 0 %}
                                        <span class="option-price">+S/ {{ option.additional_cost }}</span>
                                        {% endif %}
                                    </span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Price Summary -->
                        <div class="price-summary-card">
                            <div class="price-breakdown">
                                <div class="price-row">
                                    <span>Precio base unitario:</span>
                                    <span id="basePriceDisplay">S/ 0.00</span>
                                </div>
                                <div class="price-row">
                                    <span>Opciones adicionales:</span>
                                    <span id="additionalCostDisplay">S/ 0.00</span>
                                </div>
                                <div class="price-row">
                                    <span>Precio unitario:</span>
                                    <span id="unitPriceDisplay" class="unit-price">S/ 0.00</span>
                                </div>
                                <div class="price-row subtotal-row">
                                    <span>Subtotal (<span id="quantityDisplay">{{ default_quantity }}</span> unidades):</span>
                                    <span id="subtotalDisplay" class="subtotal">S/ 0.00</span>
                                </div>
                                {% if price_tiers|length > 1 %}
                                <div class="price-row savings-row" id="savingsRow" style="display: none;">
                                    <span><i class="fas fa-tag"></i> Descuento por volumen:</span>
                                    <span id="savingsDisplay" class="savings">-S/ 0.00</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="total-price-row">
                                <span class="total-label">Precio Total:</span>
                                <span id="totalPriceDisplay" class="total-price">S/ 0.00</span>
                            </div>

                            <div class="price-note">
                                <i class="fas fa-info-circle"></i>
                                <small>Los precios incluyen IGV. El precio final puede variar según las opciones seleccionadas.</small>
                            </div>
                        </div>

                        <!-- Add to Cart Button -->
                        <div class="cart-actions">
                            <button type="button" class="btn btn-primary btn-lg btn-add-to-cart" id="addToCartBtn">
                                <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                            </button>
                        </div>

                        <!-- Validation Messages -->
                        <div id="validationMessages" class="validation-messages" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Details Tabs -->
        <div class="product-details-tabs">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#specifications">
                        <i class="fas fa-list"></i> Especificaciones
                    </a>
                </li>
                {% if product.features %}
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#features">
                        <i class="fas fa-star"></i> Características
                    </a>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#shipping">
                        <i class="fas fa-truck"></i> Envío y Entrega
                    </a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="specifications">
                    <div class="specifications-content">
                        <h4>Especificaciones del Producto</h4>
                        {% if product.specifications %}
                        {{ product.specifications|linebreaks }}
                        {% else %}
                        <p>Las especificaciones varían según las opciones seleccionadas.</p>
                        {% endif %}
                    </div>
                </div>

                {% if product.features %}
                <div class="tab-pane fade" id="features">
                    <div class="features-content">
                        <h4>Características Destacadas</h4>
                        {{ product.features|linebreaks }}
                    </div>
                </div>
                {% endif %}

                <div class="tab-pane fade" id="shipping">
                    <div class="shipping-content">
                        <h4>Información de Envío</h4>
                        <p><i class="fas fa-check-circle text-success"></i> Envío a todo el Perú</p>
                        <p><i class="fas fa-clock"></i> Tiempo de producción: 3-5 días hábiles</p>
                        <p><i class="fas fa-truck"></i> Tiempo de envío: 2-3 días hábiles (Lima), 3-5 días hábiles (Provincias)</p>
                        <p><i class="fas fa-box"></i> Embalaje seguro para proteger tu producto</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Similar Products -->
        {% if similar_products %}
        <div class="similar-products-section">
            <h3 class="section-title">Productos Relacionados</h3>
            <div class="products-grid">
                {% for similar in similar_products %}
                <div class="product-card">
                    <a href="{% url 'catalog:product_detail' similar.category.slug similar.slug %}" class="product-link">
                        {% if similar.image %}
                        <div class="product-image">
                            <img src="{{ similar.image.url }}" alt="{{ similar.name }}" loading="lazy">
                        </div>
                        {% else %}
                        <div class="product-image placeholder">
                            <i class="fas fa-image"></i>
                        </div>
                        {% endif %}
                        
                        <div class="product-info">
                            <h3 class="product-name">{{ similar.name }}</h3>
                            <div class="product-pricing">
                                {% if similar.min_price %}
                                <span class="price-from">Desde</span>
                                <span class="price-amount">S/ {{ similar.min_price }}</span>
                                {% else %}
                                <span class="price-label">Personalizable</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="productData" type="application/json">
{
    "product_slug": "{{ product.slug }}",
    "min_quantity": {{ price_tiers.0.min_quantity }},
    "price_tiers": {{ price_tiers|safe }},
    "variants": {{ variants|safe }},
    "calculate_price_url": "{% url 'catalog:calculate_price_ajax' %}",
    "validate_config_url": "{% url 'catalog:validate_config_ajax' %}",
    "add_to_cart_url": "{% url 'cart:add_item' %}"
}
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/catalog.js' %}"></script>
<script src="{% static 'js/product-configurator.js' %}"></script>
{% endblock %}
