{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} | Imprenta Gallito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clothing.css' %}">
<link rel="stylesheet" href="{% static 'css/clothing-detail.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-page">
    <nav class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li><a href="{% url 'shop:home' %}">Inicio</a></li>
                <li><a href="{% url 'shop:category' category_slug='ropa-bolsos' %}">Ropa y Bolsas</a></li>
                <li><a href="{% url 'shop:clothing_category' category_slug=category.slug %}">{{ category.name }}</a></li>
                <li class="active">{{ product.name }}</li>
            </ol>
        </div>
    </nav>

    <main class="product-main">
        <div class="container">
            <div class="product-detail-layout">
                <div class="product-gallery">
                    <div class="main-image-container">
                        <img id="main-product-image" 
                             src="{{ base_image_url }}" 
                             alt="{{ product.name }}">
                    </div>

                    <div class="thumbnail-list">
                        </div>
                </div>

                <div class="product-info">
                    <h1 class="product-title">{{ product.name }}</h1>
                    <p class="product-code">SKU: {{ product.sku }}</p>
                    
                    <div class="product-pricing">
                        {% for tier in pricing_tiers %}
                            {% if forloop.first %}
                            <span class="price-label">Precio desde:</span>
                            <span class="main-price">S/ {{ tier.price|floatformat:2 }}</span>
                            <span class="unit-price">/unidad (Min. {{ tier.min_quantity }})</span>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div class="option-section">
                        <h4>Color: <span id="selected-color-name">
                            {# CORRECCIÓN: Usar el objeto selected_color pasado desde la vista #}
                            {% if selected_color %}
                                {{ selected_color.name }}
                            {% else %}
                                Por defecto
                            {% endif %}
                        </span></h4>
                        <div class="color-swatches-container">
                            {% for color in product.colors.all %}
                            <div class="color-dot {% if color.slug == selected_color_slug %}active{% endif %}" 
                                data-color-slug="{{ color.slug }}" 
                                data-color-name="{{ color.name }}"
                                style="background-color: {{ color.hex_code }};"
                            ></div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="option-section">
                        <h4>Talla:</h4>
                        <div class="size-options-grid">
                            {% for size in product.sizes.all %}
                            <div class="size-dot" data-size-slug="{{ size.slug }}">
                                {{ size.name }}
                            </div>
                            {% endfor %}
                        </div>
                        <button id="size-guide-btn" class="text-link mt-2">Guía de Tallas</button>
                    </div>

                    <div class="option-section">
                        <h4>Cantidad:</h4>
                        <input type="number" id="quantity-input" value="1" min="1" class="form-control d-inline-block w-auto" oninput="updatePrice()">
                    </div>
                    
                    <div class="add-to-cart-section">
                        <span class="subtotal-label">Subtotal:</span>
                        <span id="subtotal" class="subtotal-value font-weight-bold">S/ 0.00</span>
                        <button class="btn btn-lg btn-primary btn-block mt-3" id="add-to-cart-btn">Añadir al Carrito</button>
                    </div>

                    <div class="product-description mt-4">
                        <h4>Descripción</h4>
                        {{ product.description|linebreaksbr }}
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    {% include 'shop/partials/related_products.html' %}

</div>

<div id="size-guide-modal" class="modal-guide">
    <div class="modal-content-guide">
        <span class="close-guide" onclick="closeSizeGuide()">&times;</span>
        <h3>Guía de Tallas</h3>
        <p>Tabla de tallas para {{ product.name }}...</p>
        </div>
</div>
{% endblock %}

{% block scripts %}
<script id="product-images-data" type="application/json">
    {{ images_by_color|safe }}
</script>
<script>
    // Obtener el color seleccionado de la URL (si existe)
    const colorFromUrl = '{{ selected_color_slug|default:""|safe }}';
    
    // Asumiendo que esta variable de precio base existe
    const basePrice = {{ pricing_tiers.first.price|floatformat:2|default:0.00 }}; 

    // Función para actualizar la imagen principal y el estado 'active' de los swatches
    function updateMainImage(colorSlug) {
        const galleryElement = document.getElementById('product-images-data');
        if (!galleryElement) return;

        let gallery;
        try {
            gallery = JSON.parse(galleryElement.textContent);
        } catch (e) {
            console.error("Error al parsear datos de imágenes:", e);
            return;
        }

        const mainImageElement = document.getElementById('main-product-image');
        if (!mainImageElement) return;

        // 1. Determinar el slug de color a buscar
        const targetSlug = colorSlug || 'default'; 
        
        let primaryImage = null;

        // 2. Buscar la imagen principal para el color objetivo
        if (gallery[targetSlug]) {
            primaryImage = gallery[targetSlug].find(img => img.is_primary);
        }
        
        // 3. Fallback a la imagen principal por defecto
        if (!primaryImage && targetSlug !== 'default' && gallery['default']) {
            primaryImage = gallery['default'].find(img => img.is_primary);
        }

        // 4. Actualizar la fuente de la imagen
        if (primaryImage) {
            mainImageElement.src = primaryImage.image;
        }
        
        // 5. Actualizar el estado 'active' de los swatches y el nombre del color
        let selectedColorName = "Por defecto";
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.classList.remove('active');
            if (dot.dataset.colorSlug === colorSlug) {
                dot.classList.add('active');
                selectedColorName = dot.dataset.colorName;
            }
        });
        document.getElementById('selected-color-name').textContent = selectedColorName;

        // Opcional: Actualizar thumbnails de galería (requeriría más lógica aquí)
    }
    
    // --------------------------------------------------------------------------
    // FUNCIONES DEL PRODUCTO
    // --------------------------------------------------------------------------

    function updatePrice() {
        const quantity = parseInt(document.getElementById('quantity-input').value) || 0;
        // Lógica de cálculo de subtotal usando basePrice (simple)
        const subtotal = quantity * basePrice; 
        
        document.getElementById('subtotal').textContent = 'S/ ' + subtotal.toFixed(2);
    }
    
    function showPreview(file) {
        const preview = document.getElementById('upload-preview');
        const placeholder = document.querySelector('.upload-placeholder');
        const previewImage = document.getElementById('preview-image');
        
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        } else {
            // For non-image files, show a file icon
            previewImage.src = '{% static "img/file-icon.png" %}';
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        }
    }
    
    function removeFile() {
        document.getElementById('design-file').value = '';
        document.getElementById('upload-preview').style.display = 'none';
        document.querySelector('.upload-placeholder').style.display = 'flex';
    }
    
    function closeSizeGuide() {
        document.getElementById('size-guide-modal').classList.remove('active');
    }
    
    // --------------------------------------------------------------------------
    // MANEJADORES DE EVENTOS
    // --------------------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
        // Inicializa la imagen principal y el swatch activo al cargar la página
        updateMainImage(colorFromUrl);
        updatePrice(); // Inicializa el precio
        
        // Evento click en los swatches de color
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', function(e) {
                e.preventDefault();
                const colorSlug = this.dataset.colorSlug;
                
                // 1. Actualiza la imagen y el estado 'active'
                updateMainImage(colorSlug);
                
                // 2. Actualizar la URL de la página sin recargar
                const url = new URL(window.location.href);
                url.searchParams.set('color', colorSlug);
                history.pushState(null, '', url.toString());
            });
        });
        
        // Evento para mostrar la guía de tallas
        document.getElementById('size-guide-btn').addEventListener('click', () => {
            document.getElementById('size-guide-modal').classList.add('active');
        });

        // Evento para cerrar la guía de tallas al clickear fuera
        document.getElementById('size-guide-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('size-guide-modal')) {
                closeSizeGuide();
            }
        });
    });
</script>
{% endblock %}