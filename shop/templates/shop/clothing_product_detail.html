{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - {{ subcategory.name }} | {{ block.super }}{% endblock %}

{% block meta_description %}{{ product.short_description|default:product.description|truncatewords:30 }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- ====================================================================
         BREADCRUMB NAVIGATION
         ==================================================================== -->
    <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm text-gray-600">
            <li><a href="/" class="hover:text-blue-600">Inicio</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href="#" class="hover:text-blue-600">{{ category.name }}</a></li>
            <li><span class="mx-2">/</span></li>
            <li>
                <a href="{% url 'shop:product_category_list' category.slug subcategory.slug %}" 
                   class="hover:text-blue-600">{{ subcategory.name }}</a>
            </li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-900 font-medium">{{ product.name }}</li>
        </ol>
    </nav>
    
    <!-- ====================================================================
         PRODUCT DETAIL GRID
         ==================================================================== -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
        
        <!-- ================================================================
             LEFT COLUMN: PRODUCT IMAGES
             ================================================================ -->
        <div class="product-images-column">
            <!-- Main Image -->
            <div class="main-image-container bg-white rounded-lg shadow-sm overflow-hidden mb-4">
                <img id="main-product-image" 
                     src="{{ base_image_url }}" 
                     alt="{{ product.name }}"
                     class="w-full h-auto object-contain"
                     style="max-height: 600px;">
            </div>
            
            <!-- Thumbnails -->
            <div id="thumbnail-container" class="thumbnails-grid"></div>
        </div>
        
        <!-- ================================================================
             RIGHT COLUMN: PRODUCT INFO
             ================================================================ -->
        <div class="product-info-column">
            
            <!-- Product Title -->
            <h1 class="text-3xl font-bold text-gray-900 mb-4">
                {{ product.name }}
            </h1>
            
            <!-- SKU -->
            {% if product.sku %}
            <p class="text-sm text-gray-500 mb-4">
                SKU: <span class="font-mono">{{ product.sku }}</span>
            </p>
            {% endif %}
            
            <!-- Short Description -->
            {% if product.short_description %}
            <p class="text-gray-700 mb-6">
                {{ product.short_description }}
            </p>
            {% endif %}
            
            <!-- Base Price -->
            <div class="mb-6">
                <p class="text-sm text-gray-600">Precio base:</p>
                <p class="text-3xl font-bold text-blue-600">
                    S/ {{ product.base_price }}
                </p>
                <p class="text-xs text-gray-500 mt-1">
                    (El precio puede variar segÃºn la cantidad)
                </p>
            </div>
            
            <hr class="my-6">
            
            <!-- ============================================================
                 COLOR SWATCHES
                 ============================================================ -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Color: 
                    <span id="selected-color-name" class="text-gray-900 font-semibold">
                        {{ selected_color.name|default:"Selecciona un color" }}
                    </span>
                </label>
                
                {% if available_colors %}
                <div class="color-swatches-container flex flex-wrap gap-3">
                    {% for color in available_colors %}
                    <button type="button"
                            class="color-swatch {% if color.slug == selected_color_slug %}active{% endif %}"
                            data-color-slug="{{ color.slug }}"
                            data-color-name="{{ color.name }}"
                            onclick="selectColor('{{ color.slug }}', '{{ color.name }}')"
                            title="{{ color.name }}"
                            style="background-color: {{ color.hex_code }};">
                        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No hay colores disponibles</p>
                {% endif %}
            </div>
            
            <!-- ============================================================
                 SIZE BUTTONS
                 ============================================================ -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">
                    Talla: 
                    <span id="selected-size-name" class="text-gray-900 font-semibold">
                        Selecciona una talla
                    </span>
                </label>
                
                {% if available_sizes %}
                <div class="size-buttons-container flex flex-wrap gap-2">
                    {% for size in available_sizes %}
                    <button type="button"
                            class="size-btn"
                            data-size-slug="{{ size.slug }}"
                            data-size-name="{{ size.name }}"
                            onclick="selectSize('{{ size.slug }}', '{{ size.name }}')">
                        {{ size.name }}
                    </button>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm">No hay tallas disponibles</p>
                {% endif %}
            </div>
            
            <hr class="my-6">
            
            <!-- ============================================================
                 QUANTITY & PRICE
                 ============================================================ -->
            <div class="mb-6">
                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">
                    Cantidad:
                </label>
                <input type="number" 
                       id="quantity" 
                       name="quantity"
                       value="1" 
                       min="1" 
                       max="10000"
                       class="w-32 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Subtotal Display -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700 font-medium">Subtotal:</span>
                    <span id="subtotal-price" class="text-2xl font-bold text-blue-600">
                        S/ {{ product.base_price }}
                    </span>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <span id="unit-price">S/ {{ product.base_price }}</span> por unidad
                </p>
            </div>
            
            <!-- Pricing Tiers Info -->
            {% if pricing_tiers %}
            <div class="mb-6">
                <p class="text-sm font-medium text-gray-700 mb-2">Precios por volumen:</p>
                <ul class="text-sm text-gray-600 space-y-1">
                    {% for tier in pricing_tiers %}
                    <li class="flex justify-between">
                        <span>{{ tier.min_quantity }}{% if tier.max_quantity < 999999 %} - {{ tier.max_quantity }}{% else %}+{% endif %} unidades:</span>
                        <span class="font-semibold">S/ {{ tier.unit_price }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- ============================================================
                 ADD TO CART BUTTON
                 ============================================================ -->
            <button id="add-to-cart-btn"
                    onclick="addToCart()"
                    class="w-full bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-md hover:shadow-lg">
                ðŸ›’ AÃ±adir al Carrito
            </button>
            
            <!-- Product Features -->
            {% if product.features %}
            <div class="mt-8 pt-8 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">CaracterÃ­sticas:</h3>
                <div class="prose prose-sm text-gray-600">
                    {{ product.features|safe }}
                </div>
            </div>
            {% endif %}
            
        </div>
    </div>
    
    <!-- ====================================================================
         PRODUCT DESCRIPTION (Full width)
         ==================================================================== -->
    {% if product.description %}
    <div class="mt-12 pt-12 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">DescripciÃ³n del Producto</h2>
        <div class="prose max-w-none text-gray-700">
            {{ product.description|safe }}
        </div>
    </div>
    {% endif %}
    
    <!-- ====================================================================
         RELATED PRODUCTS
         ==================================================================== -->
    {% if related_products %}
    <div class="mt-16 pt-12 border-t border-gray-200">
        <h2 class="text-2xl font-bold text-gray-900 mb-8">Productos Relacionados</h2>
        
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for related in related_products %}
            <div class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200">
                <a href="{% url 'shop:product_detail' category.slug subcategory.slug related.slug %}">
                    <div class="aspect-square overflow-hidden rounded-t-lg">
                        <img src="{{ related.base_image_url }}" 
                             alt="{{ related.name }}"
                             class="w-full h-full object-cover hover:scale-105 transition-transform duration-200">
                    </div>
                    <div class="p-4">
                        <h3 class="font-semibold text-gray-900 text-sm mb-2 line-clamp-2">
                            {{ related.name }}
                        </h3>
                        <p class="text-blue-600 font-bold">
                            S/ {{ related.base_price }}
                        </p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
</div>
{% endblock %}

<!-- ========================================================================
     EXTRA CSS STYLES
     ======================================================================== -->
{% block extra_css %}
<style>
/* Color Swatches */
.color-swatches-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.color-swatch {
    position: relative;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.color-swatch:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.color-swatch.active {
    border-color: #0066cc;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #0066cc;
}

.color-swatch .checkmark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 24px;
    height: 24px;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.color-swatch.active .checkmark {
    opacity: 1;
}

/* Size Buttons */
.size-buttons-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.size-btn {
    padding: 0.5rem 1rem;
    border: 2px solid #d1d5db;
    border-radius: 0.375rem;
    background-color: white;
    color: #374151;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.size-btn:hover {
    border-color: #0066cc;
    background-color: #eff6ff;
    color: #0066cc;
}

.size-btn.active {
    border-color: #0066cc;
    background-color: #0066cc;
    color: white;
}

.size-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Thumbnails */
#thumbnail-container {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
}

.thumbnail-btn {
    flex-shrink: 0;
    width: 80px;
    height: 80px;
    border: 2px solid #d1d5db;
    border-radius: 0.375rem;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.thumbnail-btn:hover {
    border-color: #0066cc;
}

.thumbnail-btn.active {
    border-color: #0066cc;
    box-shadow: 0 0 0 2px white, 0 0 0 4px #0066cc;
}

.thumbnail-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Main Image */
#main-product-image {
    transition: opacity 0.15s ease;
}

/* Add to Cart Button */
#add-to-cart-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Quantity Input */
#quantity {
    -moz-appearance: textfield;
}

#quantity::-webkit-outer-spin-button,
#quantity::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
</style>
{% endblock %}

<!-- ========================================================================
     JAVASCRIPT
     ======================================================================== -->
{% block extra_js %}
<script>
    // ====================================================================
    // VARIABLES GLOBALES
    // ====================================================================
    
    let selectedColorSlug = '{{ selected_color_slug }}' || '';
    let selectedSizeSlug = '';
    let imagesByColor = {};
    
    // Parsear imÃ¡genes por color
    try {
        imagesByColor = JSON.parse('{{ images_by_color|escapejs }}' || '{}');
        console.log('âœ… ImÃ¡genes cargadas:', Object.keys(imagesByColor).length, 'colores');
    } catch (e) {
        console.error('âŒ Error al parsear images_by_color:', e);
    }
    
    // Pricing tiers
    const pricingTiers = [
        {% for tier in pricing_tiers %}
        {
            min: {{ tier.min_quantity }},
            max: {{ tier.max_quantity }},
            price: {{ tier.unit_price }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const basePrice = {{ product.base_price }};
    
    // ====================================================================
    // FUNCIÃ“N: selectColor
    // ====================================================================
    
    function selectColor(colorSlug, colorName) {
        console.log('ðŸŽ¨ selectColor:', colorSlug, colorName);
        
        selectedColorSlug = colorSlug;
        
        // Actualizar swatches activos
        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.classList.remove('active');
        });
        
        const activeSwatch = document.querySelector(`.color-swatch[data-color-slug="${colorSlug}"]`);
        if (activeSwatch) {
            activeSwatch.classList.add('active');
        }
        
        // Actualizar nombre del color
        const colorNameDisplay = document.getElementById('selected-color-name');
        if (colorNameDisplay) {
            colorNameDisplay.textContent = colorName;
        }
        
        // Actualizar imÃ¡genes
        updateMainImage(colorSlug);
        updateThumbnails(colorSlug);
        
        // Actualizar URL sin recargar
        const url = new URL(window.location);
        url.searchParams.set('color', colorSlug);
        window.history.pushState({}, '', url);
    }
    
    // ====================================================================
    // FUNCIÃ“N: updateMainImage
    // ====================================================================
    
    function updateMainImage(colorSlug) {
        console.log('ðŸ–¼ï¸ updateMainImage:', colorSlug);
        
        const mainImage = document.getElementById('main-product-image');
        if (!mainImage) {
            console.error('âŒ No se encontrÃ³ #main-product-image');
            return;
        }
        
        const images = imagesByColor[colorSlug];
        if (!images || !images.length) {
            console.warn('âš ï¸ No hay imÃ¡genes para el color:', colorSlug);
            return;
        }
        
        // Buscar imagen principal
        let mainImageData = images.find(img => img.is_primary);
        if (!mainImageData) {
            mainImageData = images[0];
        }
        
        // Actualizar con efecto fade
        mainImage.style.opacity = '0.5';
        setTimeout(() => {
            mainImage.src = mainImageData.image;
            mainImage.alt = mainImageData.alt_text || '{{ product.name }}';
            mainImage.style.opacity = '1';
            console.log('âœ… Imagen actualizada');
        }, 150);
    }
    
    // ====================================================================
    // FUNCIÃ“N: updateThumbnails
    // ====================================================================
    
    function updateThumbnails(colorSlug) {
        const thumbnailContainer = document.getElementById('thumbnail-container');
        if (!thumbnailContainer) return;
        
        const images = imagesByColor[colorSlug];
        if (!images || images.length <= 1) {
            thumbnailContainer.innerHTML = '';
            return;
        }
        
        // Generar thumbnails HTML
        let thumbnailsHTML = '';
        images.forEach((img, index) => {
            const activeClass = index === 0 ? 'active' : '';
            thumbnailsHTML += `
                <button type="button" 
                        class="thumbnail-btn ${activeClass}" 
                        onclick="changeMainImage('${img.image.replace(/'/g, "\\'")}', this)">
                    <img src="${img.image}" 
                         alt="${img.alt_text || '{{ product.name }}'}"
                         class="thumbnail-image">
                </button>
            `;
        });
        
        thumbnailContainer.innerHTML = thumbnailsHTML;
    }
    
    // ====================================================================
    // FUNCIÃ“N: changeMainImage
    // ====================================================================
    
    function changeMainImage(imageUrl, thumbnailBtn) {
        const mainImage = document.getElementById('main-product-image');
        if (!mainImage) return;
        
        mainImage.style.opacity = '0.5';
        setTimeout(() => {
            mainImage.src = imageUrl;
            mainImage.style.opacity = '1';
        }, 150);
        
        // Actualizar thumbnails activos
        document.querySelectorAll('.thumbnail-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        if (thumbnailBtn) {
            thumbnailBtn.classList.add('active');
        }
    }
    
    // ====================================================================
    // FUNCIÃ“N: selectSize
    // ====================================================================
    
    function selectSize(sizeSlug, sizeName) {
        console.log('ðŸ“ selectSize:', sizeSlug, sizeName);
        
        selectedSizeSlug = sizeSlug;
        
        // Actualizar botones activos
        document.querySelectorAll('.size-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        const activeBtn = document.querySelector(`.size-btn[data-size-slug="${sizeSlug}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // Actualizar nombre de la talla
        const sizeNameDisplay = document.getElementById('selected-size-name');
        if (sizeNameDisplay) {
            sizeNameDisplay.textContent = sizeName;
        }
    }
    
    // ====================================================================
    // FUNCIÃ“N: updatePrice
    // ====================================================================
    
    function updatePrice() {
        const quantityInput = document.getElementById('quantity');
        const subtotalDisplay = document.getElementById('subtotal-price');
        const unitPriceDisplay = document.getElementById('unit-price');
        
        if (!quantityInput || !subtotalDisplay) return;
        
        const quantity = parseInt(quantityInput.value) || 1;
        
        // Buscar el tier de precio correspondiente
        let unitPrice = basePrice;
        
        for (const tier of pricingTiers) {
            if (quantity >= tier.min && quantity <= tier.max) {
                unitPrice = tier.price;
                break;
            }
        }
        
        const subtotal = unitPrice * quantity;
        
        // Actualizar displays
        subtotalDisplay.textContent = `S/ ${subtotal.toFixed(2)}`;
        if (unitPriceDisplay) {
            unitPriceDisplay.textContent = `S/ ${unitPrice.toFixed(2)}`;
        }
    }
    
    // ====================================================================
    // FUNCIÃ“N: addToCart
    // ====================================================================
    
    function addToCart() {
        console.log('ðŸ›’ addToCart llamado');
        
        // Validar color
        if (!selectedColorSlug) {
            alert('âŒ Por favor selecciona un color');
            return;
        }
        
        // Validar talla
        if (!selectedSizeSlug) {
            alert('âŒ Por favor selecciona una talla');
            return;
        }
        
        // Validar cantidad
        const quantityInput = document.getElementById('quantity');
        const quantity = parseInt(quantityInput.value);
        
        if (!quantity || quantity < 1) {
            alert('âŒ Por favor ingresa una cantidad vÃ¡lida');
            return;
        }
        
        // Deshabilitar botÃ³n
        const addBtn = document.getElementById('add-to-cart-btn');
        if (!addBtn) return;
        
        const originalText = addBtn.innerHTML;
        addBtn.disabled = true;
        addBtn.innerHTML = 'â³ Agregando...';
        
        // Hacer peticiÃ³n al servidor
        fetch('/api/cart/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'product_slug': '{{ product.slug }}',
                'color_slug': selectedColorSlug,
                'size_slug': selectedSizeSlug,
                'quantity': quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mensaje de Ã©xito
                alert(`âœ… ${data.message}\n\n` +
                      `Color: ${data.item.color}\n` +
                      `Talla: ${data.item.size}\n` +
                      `Cantidad: ${data.item.quantity} unidades`);
                
                // Actualizar contador del carrito en la navegaciÃ³n
                const cartCounter = document.getElementById('cart-count');
                if (cartCounter) {
                    cartCounter.textContent = data.cart_count;
                }
                
                // Opcional: Redirigir al carrito
                // window.location.href = '/carrito-de-compras/';
            } else {
                alert('âŒ Error: ' + (data.error || 'No se pudo agregar al carrito'));
            }
        })
        .catch(error => {
            console.error('âŒ Error:', error);
            alert('âŒ Error al agregar al carrito. Por favor intenta de nuevo.');
        })
        .finally(() => {
            // Rehabilitar botÃ³n
            addBtn.disabled = false;
            addBtn.innerHTML = originalText;
        });
    }
    
    // ====================================================================
    // INICIALIZACIÃ“N
    // ====================================================================
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸš€ Inicializando producto...');
        console.log('   Producto: {{ product.name }}');
        console.log('   Color seleccionado:', selectedColorSlug);
        console.log('   Colores disponibles:', Object.keys(imagesByColor));
        
        // Inicializar thumbnails del color seleccionado
        if (selectedColorSlug) {
            updateThumbnails(selectedColorSlug);
        }
        
        // Event listeners para cantidad
        const quantityInput = document.getElementById('quantity');
        if (quantityInput) {
            quantityInput.addEventListener('input', updatePrice);
            quantityInput.addEventListener('change', updatePrice);
        }
        
        // Calcular precio inicial
        updatePrice();
        
        console.log('âœ… InicializaciÃ³n completa');
    });
</script>
{% endblock %}
