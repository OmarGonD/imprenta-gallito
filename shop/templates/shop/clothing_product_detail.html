{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} | Imprenta Gallito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clothing.css' %}">
<link rel="stylesheet" href="{% static 'css/clothing-detail.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail-page">
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li><a href="{% url 'shop:allCat' %}">Inicio</a></li>
                <li><a href="{% url 'shop:ropa_bolsas' %}">Ropa y Bolsas</a></li>
                <li><a href="{% url 'shop:clothing_category' category.slug %}">{{ category.name }}</a></li>
                <li class="active">{{ product.name }}</li>
            </ol>
        </div>
    </nav>

    <!-- Product Main Section -->
    <main class="product-main">
        <div class="container">
            <div class="product-detail-layout">
                <!-- Product Gallery -->
                <div class="product-gallery">
                    <div class="main-image-container">
                        <img id="main-product-image" 
                             src="{% if product.main_image %}{{ product.main_image.url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}" 
                             alt="{{ product.name }}"
                             class="main-product-image">
                        {% if product.is_new %}
                        <span class="badge badge-new">Nuevo</span>
                        {% endif %}
                        {% if product.discount_percentage %}
                        <span class="badge badge-sale">-{{ product.discount_percentage }}%</span>
                        {% endif %}
                    </div>
                    
                    <div class="thumbnail-gallery">
                        {% if product.main_image %}
                        <button type="button" class="thumbnail active" data-image="{{ product.main_image.url }}">
                            <img src="{{ product.main_image.url }}" alt="{{ product.name }}">
                        </button>
                        {% endif %}
                        {% for img in default_images %}
                        <button type="button" class="thumbnail" data-image="{{ img.image.url }}">
                            <img src="{{ img.image.url }}" alt="{{ img.alt_text }}">
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Product Info -->
                <div class="product-info-section">
                    <div class="product-header">
                        <h1 class="product-title">{{ product.name }}</h1>
                        <p class="product-sku">SKU: {{ product.sku }}</p>
                    </div>

                    {% if product.short_description %}
                    <p class="product-short-desc">{{ product.short_description }}</p>
                    {% endif %}

                    <!-- Pricing -->
                    <div class="product-pricing-section">
                        {% if product.sale_price %}
                        <div class="price-box">
                            <span class="price-original">S/ {{ product.base_price }}</span>
                            <span class="price-sale">S/ {{ product.sale_price }}</span>
                            <span class="price-save">Ahorras {{ product.discount_percentage }}%</span>
                        </div>
                        {% else %}
                        <div class="price-box">
                            <span class="price-label">Desde</span>
                            <span class="price-main">S/ {{ product.base_price }}</span>
                            <span class="price-unit">por unidad</span>
                        </div>
                        {% endif %}
                        
                        {% if pricing_tiers %}
                        <div class="quantity-pricing">
                            <h4>Precios por cantidad:</h4>
                            <table class="pricing-table">
                                <thead>
                                    <tr>
                                        <th>Cantidad</th>
                                        <th>Precio/und</th>
                                        <th>Ahorro</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tier in pricing_tiers %}
                                    <tr>
                                        <td>{{ tier.min_quantity }}{% if tier.max_quantity %} - {{ tier.max_quantity }}{% else %}+{% endif %}</td>
                                        <td>S/ {{ tier.price_per_unit }}</td>
                                        <td class="savings">
                                            {% widthratio product.base_price 1 tier.price_per_unit as tier_percent %}
                                            -{{ tier_percent|floatformat:0 }}%
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Customization Form -->
                    <form id="add-to-cart-form" class="customization-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}">
                        
                        <!-- Color Selection -->
                        {% if product.available_colors.count > 0 %}
                        <div class="option-section">
                            <label class="option-label">
                                Color: <span id="selected-color-name">Selecciona un color</span>
                            </label>
                            <div class="color-selector">
                                {% for color in product.available_colors.all %}
                                <label class="color-option-detail" title="{{ color.name }}">
                                    <input type="radio" name="color" value="{{ color.slug }}" 
                                           data-color-name="{{ color.name }}"
                                           data-hex="{{ color.hex_code }}"
                                           {% if forloop.first %}checked{% endif %}>
                                    <span class="color-circle" style="background-color: {{ color.hex_code }};"></span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Size Selection -->
                        {% if product.available_sizes.count > 0 %}
                        <div class="option-section">
                            <label class="option-label">
                                Talla: <span id="selected-size-name">Selecciona una talla</span>
                            </label>
                            <div class="size-selector">
                                {% for size in product.available_sizes.all %}
                                <label class="size-option-detail">
                                    <input type="radio" name="size" value="{{ size.name }}"
                                           data-size-name="{{ size.display_name }}"
                                           {% if forloop.first %}checked{% endif %}>
                                    <span class="size-button">{{ size.name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            <a href="#" class="size-guide-link"><i class="fas fa-ruler"></i> Guía de tallas</a>
                        </div>
                        {% endif %}

                        <!-- Quantity -->
                        <div class="option-section">
                            <label class="option-label">Cantidad:</label>
                            <div class="quantity-selector">
                                <button type="button" class="qty-btn minus" onclick="updateQuantity(-1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" name="quantity" id="quantity-input" 
                                       value="{{ product.min_quantity }}" 
                                       min="{{ product.min_quantity }}" 
                                       max="1000">
                                <button type="button" class="qty-btn plus" onclick="updateQuantity(1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <span class="min-qty-note">Mínimo: {{ product.min_quantity }} unidades</span>
                        </div>

                        <!-- Upload Design (Optional) -->
                        <div class="option-section">
                            <label class="option-label">Sube tu diseño (opcional):</label>
                            <div class="upload-area" id="upload-area">
                                <input type="file" name="design_file" id="design-file" accept="image/*,.pdf,.ai,.psd" hidden>
                                <div class="upload-placeholder" onclick="document.getElementById('design-file').click()">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Arrastra tu archivo aquí o <span>haz clic para seleccionar</span></p>
                                    <small>Formatos: JPG, PNG, PDF, AI, PSD</small>
                                </div>
                                <div class="upload-preview" id="upload-preview" style="display: none;">
                                    <img id="preview-image" src="" alt="Preview">
                                    <button type="button" class="remove-file" onclick="removeFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Total Price -->
                        <div class="total-section">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <span class="subtotal" id="subtotal">S/ {{ product.current_price }}</span>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button type="submit" class="btn-add-cart">
                                <i class="fas fa-shopping-cart"></i> Agregar al Carrito
                            </button>
                            <button type="button" class="btn-customize-design">
                                <i class="fas fa-paint-brush"></i> Personalizar Diseño
                            </button>
                        </div>
                    </form>

                    <!-- Product Features -->
                    {% if product.features_list %}
                    <div class="product-features">
                        <h4>Características:</h4>
                        <ul>
                            {% for feature in product.features_list %}
                            <li><i class="fas fa-check"></i> {{ feature }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Additional Info -->
                    <div class="additional-info">
                        {% if product.material %}
                        <div class="info-item">
                            <i class="fas fa-layer-group"></i>
                            <span><strong>Material:</strong> {{ product.material }}</span>
                        </div>
                        {% endif %}
                        {% if product.weight %}
                        <div class="info-item">
                            <i class="fas fa-weight-hanging"></i>
                            <span><strong>Peso:</strong> {{ product.weight }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Guarantees -->
                    <div class="guarantees">
                        <div class="guarantee-item">
                            <i class="fas fa-truck"></i>
                            <span>Envío a todo el Perú</span>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-undo"></i>
                            <span>Garantía de satisfacción</span>
                        </div>
                        <div class="guarantee-item">
                            <i class="fas fa-headset"></i>
                            <span>Soporte por WhatsApp</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Description -->
            {% if product.description %}
            <div class="product-description-section">
                <h2>Descripción del Producto</h2>
                <div class="description-content">
                    {{ product.description|linebreaks }}
                </div>
            </div>
            {% endif %}

            <!-- Related Products -->
            {% if related_products %}
            <section class="related-products">
                <h2>Productos Relacionados</h2>
                <div class="related-grid">
                    {% for related in related_products %}
                    <article class="product-card">
                        <a href="{{ related.get_absolute_url }}" class="product-image-wrapper">
                            <img src="{% if related.main_image %}{{ related.main_image.url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}" 
                                 alt="{{ related.name }}" class="product-image primary">
                        </a>
                        <div class="product-info">
                            <h3 class="product-name">
                                <a href="{{ related.get_absolute_url }}">{{ related.name }}</a>
                            </h3>
                            <div class="product-pricing">
                                <span class="price-current">Desde S/ {{ related.base_price }}</span>
                            </div>
                            <div class="product-actions">
                                <a href="{{ related.get_absolute_url }}" class="btn-customize">
                                    <i class="fas fa-paint-brush"></i> Ver Producto
                                </a>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>
    </main>
</div>

<!-- Size Guide Modal -->
<div class="modal" id="size-guide-modal">
    <div class="modal-content">
        <button type="button" class="modal-close" onclick="closeSizeGuide()">
            <i class="fas fa-times"></i>
        </button>
        <h3>Guía de Tallas</h3>
        <table class="size-guide-table">
            <thead>
                <tr>
                    <th>Talla</th>
                    <th>Pecho (cm)</th>
                    <th>Largo (cm)</th>
                    <th>Hombros (cm)</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>XS</td><td>86-91</td><td>66</td><td>42</td></tr>
                <tr><td>S</td><td>91-96</td><td>69</td><td>44</td></tr>
                <tr><td>M</td><td>96-101</td><td>72</td><td>46</td></tr>
                <tr><td>L</td><td>101-106</td><td>74</td><td>48</td></tr>
                <tr><td>XL</td><td>106-112</td><td>76</td><td>50</td></tr>
                <tr><td>XXL</td><td>112-117</td><td>78</td><td>52</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const basePrice = {{ product.current_price }};
    const minQty = {{ product.min_quantity }};
    
    // Color selection
    document.querySelectorAll('input[name="color"]').forEach(function(input) {
        input.addEventListener('change', function() {
            const colorName = this.getAttribute('data-color-name');
            document.getElementById('selected-color-name').textContent = colorName;
            
            // Update product image based on color if available
            const colorSlug = this.value;
            const imagesForColor = {{ images_by_color|safe }};
            if (imagesForColor && imagesForColor[colorSlug] && imagesForColor[colorSlug].length > 0) {
                document.getElementById('main-product-image').src = imagesForColor[colorSlug][0].image;
            }
        });
        
        // Trigger initial selection
        if (input.checked) {
            input.dispatchEvent(new Event('change'));
        }
    });
    
    // Size selection
    document.querySelectorAll('input[name="size"]').forEach(function(input) {
        input.addEventListener('change', function() {
            const sizeName = this.getAttribute('data-size-name');
            document.getElementById('selected-size-name').textContent = sizeName;
        });
        
        if (input.checked) {
            input.dispatchEvent(new Event('change'));
        }
    });
    
    // Quantity update
    document.getElementById('quantity-input').addEventListener('change', function() {
        updateTotal();
    });
    
    // Thumbnail gallery
    document.querySelectorAll('.thumbnail').forEach(function(thumb) {
        thumb.addEventListener('click', function() {
            const imageUrl = this.getAttribute('data-image');
            document.getElementById('main-product-image').src = imageUrl;
            
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Size guide link
    document.querySelector('.size-guide-link')?.addEventListener('click', function(e) {
        e.preventDefault();
        document.getElementById('size-guide-modal').classList.add('active');
    });
    
    // File upload
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('design-file');
    
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function() {
        this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            showPreview(e.dataTransfer.files[0]);
        }
    });
    
    fileInput.addEventListener('change', function() {
        if (this.files.length) {
            showPreview(this.files[0]);
        }
    });
    
    // Form submission
    document.getElementById('add-to-cart-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{% url "shop:add_clothing_to_cart" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cart counter
                const cartCounter = document.querySelector('.cart-counter');
                if (cartCounter) {
                    cartCounter.textContent = data.cart_items_counter;
                }
                
                // Show success message
                alert('¡Producto agregado al carrito!');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});

function updateQuantity(change) {
    const input = document.getElementById('quantity-input');
    const minQty = parseInt(input.min);
    let newValue = parseInt(input.value) + change;
    
    if (newValue < minQty) newValue = minQty;
    if (newValue > 1000) newValue = 1000;
    
    input.value = newValue;
    updateTotal();
}

function updateTotal() {
    const quantity = parseInt(document.getElementById('quantity-input').value);
    const basePrice = {{ product.current_price }};
    const subtotal = quantity * basePrice;
    
    document.getElementById('subtotal').textContent = 'S/ ' + subtotal.toFixed(2);
}

function showPreview(file) {
    const preview = document.getElementById('upload-preview');
    const placeholder = document.querySelector('.upload-placeholder');
    const previewImage = document.getElementById('preview-image');
    
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        };
        reader.readAsDataURL(file);
    } else {
        // For non-image files, show a file icon
        previewImage.src = '{% static "img/file-icon.png" %}';
        preview.style.display = 'block';
        placeholder.style.display = 'none';
    }
}

function removeFile() {
    document.getElementById('design-file').value = '';
    document.getElementById('upload-preview').style.display = 'none';
    document.querySelector('.upload-placeholder').style.display = 'flex';
}

function closeSizeGuide() {
    document.getElementById('size-guide-modal').classList.remove('active');
}

// Close modal on outside click
document.getElementById('size-guide-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeSizeGuide();
    }
});
</script>
{% endblock %}
