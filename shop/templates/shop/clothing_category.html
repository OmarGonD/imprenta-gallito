{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} | Ropa y Bolsas | Imprenta Gallito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clothing.css' %}">
<style>
    .filter-options-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-option-btn input[type="checkbox"] { display: none; }
    .filter-option-btn span { padding: 8px 14px; border: 1px solid #ddd; border-radius: 20px; font-size: 0.85rem; color: #555; background: #fff; transition: all 0.2s ease; }
    .filter-option-btn:hover span { border-color: #0066cc; color: #0066cc; }
    .filter-option-btn input[type="checkbox"]:checked+span { background: #0066cc; border-color: #0066cc; color: #fff; }

    .product-colors { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; justify-content: center; }
    .color-dot {
        width: 18px; height: 18px; border-radius: 50%; cursor: pointer;
        border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        transition: all 0.25s ease;
    }
    .color-dot:hover { transform: scale(1.2); }
    .color-dot.active {
        border-color: #0066cc;
        box-shadow: 0 0 0 3px #e3f2fd, 0 0 0 1px #0066cc;
    }

    .no-products { text-align: center; padding: 60px 20px; color: #666; }
    .no-products i { font-size: 64px; margin-bottom: 20px; opacity: 0.3; }
</style>
{% endblock %}

{% block content %}
<div class="clothing-page">
    <section class="clothing-hero" style="padding: 40px 20px;">
        <div class="hero-content">
            <h1>{{ category.name }}</h1>
            <p>{{ category.description }}</p>
        </div>
    </section>

    <nav class="breadcrumb-nav">
        <div class="container">
            <ol class="breadcrumb">
                <li><a href="{% url 'shop:home' %}">Inicio</a></li>
                <li><a href="{% url 'shop:ropa_bolsos' %}">Ropa y Bolsas</a></li>
                <li class="active">{{ category.name }}</li>
            </ol>
        </div>
    </nav>

    {% if subcategories %}
    <section class="categories-nav">
        <div class="container">
            <div class="categories-grid">
                {% for sub in subcategories %}
                <a href="{% url 'shop:clothing_category' sub.slug %}"
                   class="category-card {% if sub.slug == category.slug %}active{% endif %}">
                    <div class="category-icon">
                        {% if sub.image_url %}
                            <img src="{{ sub.image_url }}" alt="{{ sub.name }}">
                        {% else %}
                            <i class="fas fa-tshirt"></i>
                        {% endif %}
                    </div>
                    <span class="category-name">{{ sub.name }}</span>
                </a>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <main class="clothing-main">
        <div class="container">
            <div class="clothing-layout">
                <aside class="filter-sidebar">
                    <div class="filter-header">
                        <h3>Filtros</h3>
                        <a href="{% url 'shop:clothing_category' category.slug %}" class="clear-filters">Limpiar todo</a>
                    </div>
                    <form id="filter-form" method="GET" action="{% url 'shop:clothing_category' category.slug %}">
                        <!-- Aquí van tus filtros de género, cuello, manga, etc. -->
                        <button type="submit" class="btn-apply-filters">Aplicar Filtros</button>
                    </form>
                </aside>

                <section class="products-section">
                    <div class="results-bar">
                        <div class="results-count"><strong>{{ product_count }}</strong> productos</div>
                        <div class="sort-options">
                            <select id="sort-select" onchange="updateSort(this.value)">
                                <option value="featured" {% if sort_by == 'featured' %}selected{% endif %}>Destacados</option>
                                <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Menor precio</option>
                                <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Mayor precio</option>
                                <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Más recientes</option>
                                <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nombre A-Z</option>
                            </select>
                        </div>
                    </div>

                    <div class="products-grid" id="products-container">
                        {% for product in products %}
                        <article class="product-card"
                                 data-product-id="{{ product.id }}"
                                 data-product-slug="{{ product.slug }}"
                                 data-base-image="{% if product.base_image_url %}{{ product.base_image_url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}">
                            {% if product.is_new %}<span class="badge badge-new">Nuevo</span>{% endif %}
                            {% if product.discount_percentage %}<span class="badge badge-sale">-{{ product.discount_percentage }}%</span>{% endif %}
                            {% if product.is_bestseller %}<span class="badge badge-best">Más vendido</span>{% endif %}

                            <!-- IMAGEN + NOMBRE + BOTÓN: todos llevan el color seleccionado -->
                            <a href="#" class="product-image-wrapper"
                                onclick="event.preventDefault(); goToDetailWithColor(this.closest('.product-card'))">
                                <img src="{% if product.base_image_url %}{{ product.base_image_url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}"
                                     alt="{{ product.name }}" class="product-image primary"
                                     id="product-img-{{ product.id }}">
                            </a>

                            <div class="product-info">
                                {% if product.material %}
                                    <span class="product-brand">{{ product.material }}</span>
                                {% endif %}

                                <h3 class="product-name">
                                    <a href="#" onclick="event.preventDefault(); goToDetailWithColor(this.closest('.product-card'))">
                                        {{ product.name }}
                                    </a>
                                </h3>

                                <!-- COLORES -->
                                {% with colors=product.available_colors.all %}
                                    {% if colors %}
                                    <div class="product-colors">
                                        {% for color in colors %}
                                        <span class="color-dot"
                                              style="background-color: {{ color.hex_code }}; 
                                                     border: 1px solid {% if color.hex_code|lower in '#ffffff,#f5f5f5,#ffff00,#fcfcfc,#fff' %}#ccc{% else %}{{ color.hex_code }}{% endif %};"
                                              title="{{ color.name }}"
                                              data-color-slug="{{ color.slug }}"
                                              data-product-id="{{ product.id }}"></span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                {% endwith %}

                                <!-- PRECIO -->
                                <div class="product-pricing">
                                    {% if product.sale_price %}
                                        <span class="price-original">S/ {{ product.base_price }}</span>
                                        <span class="price-current">S/ {{ product.sale_price }}</span>
                                    {% else %}
                                        <span class="price-current">Desde S/ {{ product.base_price|default:"25.00" }}</span>
                                    {% endif %}
                                </div>

                                <!-- BOTÓN PERSONALIZAR -->
                                <div class="product-actions">
                                    <a href="#" 
                                       onclick="event.preventDefault(); goToDetailWithColor(this.closest('.product-card'))"
                                       class="btn-customize">
                                        Personalizar
                                    </a>
                                </div>
                            </div>
                        </article>

                        {% empty %}
                        <div class="no-products">
                            <i class="fas fa-box-open"></i>
                            <h3>No hay productos disponibles</h3>
                            <p>Intenta con otros filtros o regresa más tarde.</p>
                        </div>
                        {% endfor %}
                    </div>
                </section>
            </div>
        </div>
    </main>
</div>

<button type="button" class="mobile-filter-btn" id="mobile-filter-toggle">
    Filtros {% if has_active_filters %}<span class="filter-badge">!</span>{% endif %}
</button>
<div class="filter-overlay" id="filter-overlay"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Para cada tarjeta de producto, inicializar el color correcto
    document.querySelectorAll('.product-card').forEach(card => {
        const dots = card.querySelectorAll('.color-dot');
        const img = card.querySelector('.product-image-wrapper img');
        const baseImage = card.dataset.baseImage;
        const productSlug = card.dataset.productSlug;
        
        if (!dots.length) return;
        
        // Buscar qué color corresponde a la imagen base usando la API
        // Mientras tanto, NO marcar ningún color como activo hasta verificar
        
        // Cargar los colores del producto y encontrar cuál corresponde a la imagen actual
        fetch(`/api/product/${productSlug}/colors/`)
            .then(r => r.json())
            .then(data => {
                if (data.colors && data.colors.length > 0) {
                    // Buscar el color que coincida con la imagen base
                    let matchingColor = null;
                    
                    for (const color of data.colors) {
                        if (color.image_url === baseImage) {
                            matchingColor = color.slug;
                            break;
                        }
                    }
                    
                    // Si no encontramos coincidencia exacta, usar el primer color
                    // y actualizar la imagen para que coincidan
                    if (!matchingColor) {
                        matchingColor = data.colors[0].slug;
                        // Actualizar la imagen al primer color disponible
                        if (data.colors[0].image_url && img) {
                            img.src = data.colors[0].image_url;
                        }
                    }
                    
                    // Marcar el color correcto como activo
                    dots.forEach(dot => {
                        if (dot.dataset.colorSlug === matchingColor) {
                            dot.classList.add('active');
                        }
                    });
                } else {
                    // Si no hay datos de la API, marcar el primer color
                    if (dots[0]) dots[0].classList.add('active');
                }
            })
            .catch(() => {
                // En caso de error, marcar el primer color como activo
                if (dots[0]) dots[0].classList.add('active');
            });
    });

    // Cambio de imagen al hacer clic en color
    document.querySelectorAll('.color-dot').forEach(swatch => {
        swatch.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const card = this.closest('.product-card');
            if (!card) return;

            // Quitar clase active de todos los dots de esta tarjeta
            card.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            this.classList.add('active');

            const slug = card.dataset.productSlug;
            const colorSlug = this.dataset.colorSlug;
            const img = card.querySelector('.product-image-wrapper img');

            if (!slug || !colorSlug || !img) return;

            // Guardar imagen original
            if (!img.dataset.originalSrc) {
                img.dataset.originalSrc = img.src;
            }

            // Cargar nueva imagen desde la API
            fetch(`/api/product/${slug}/colors/?color=${encodeURIComponent(colorSlug)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.image) img.src = data.image;
                })
                .catch(() => {});
        });
    });
});

// Redirigir al detalle con el color seleccionado
// CORREGIDO: Ahora incluye /producto/ en la URL
function goToDetailWithColor(card) {
    const productSlug = card.dataset.productSlug;
    const categorySlug = "{{ category.slug }}";
    const activeSwatch = card.querySelector('.color-dot.active') || card.querySelector('.color-dot');
    const colorSlug = activeSwatch ? activeSwatch.dataset.colorSlug : '';
    
    // URL CORRECTA: /ropa-bolsos/categoria/producto/slug-producto/?color=color
    window.location.href = `/ropa-bolsos/${categorySlug}/producto/${encodeURIComponent(productSlug)}/?color=${colorSlug}`;
}

function updateSort(value) {
    const url = new URL(window.location);
    url.searchParams.set('sort', value);
    window.location = url;
}
</script>
{% endblock %}
