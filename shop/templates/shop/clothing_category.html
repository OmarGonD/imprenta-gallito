{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} | Ropa y Bolsas | Imprenta Gallito{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen">
    
    <!-- Hero Section -->
    <section class="bg-gradient-to-br from-indigo-900 via-purple-800 to-indigo-900 py-12 px-4">
        <div class="max-w-6xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">{{ category.name }}</h1>
            <p class="text-xl text-white/85 max-w-2xl mx-auto">{{ category.description }}</p>
        </div>
    </section>

    <!-- Breadcrumb -->
    <nav class="bg-white border-b border-gray-200 py-4">
        <div class="max-w-6xl mx-auto px-4">
            <ol class="flex items-center gap-2 text-sm">
                <li><a href="{% url 'shop:home' %}" class="text-gray-500 hover:text-blue-600 transition-colors">Inicio</a></li>
                <li class="text-gray-400">/</li>
                <li><a href="{% url 'shop:clothing_category' %}" class="text-gray-500 hover:text-blue-600 transition-colors">Ropa y Bolsas</a></li>
                <li class="text-gray-400">/</li>
                <li class="text-gray-900 font-medium">{{ category.name }}</li>
            </ol>
        </div>
    </nav>

    <!-- Subcategories Navigation (Circles) -->
    {% if subcategories %}
    <section class="bg-white py-8 border-b border-gray-200">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-wrap justify-center gap-8">
                {% for sub in subcategories %}
                <a href="{% url 'shop:clothing_subcategory' category.slug sub.slug %}"
                   class="flex flex-col items-center w-24 transition-transform hover:-translate-y-1 group">
                    <div class="w-16 h-16 rounded-full overflow-hidden border-4 mb-2 transition-all
                                {% if sub.slug == subcategory.slug %}border-purple-500 shadow-lg{% else %}border-gray-200 group-hover:border-purple-400{% endif %}">
                        {% if sub.image_url %}
                        <img src="{{ sub.image_url }}" alt="{{ sub.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full bg-gradient-to-br from-purple-500 to-indigo-600 flex items-center justify-center">
                            <i class="fas fa-tshirt text-white text-lg"></i>
                        </div>
                        {% endif %}
                    </div>
                    <span class="text-xs font-medium text-center text-gray-700 group-hover:text-purple-600 transition-colors">
                        {{ sub.name }}
                    </span>
                </a>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Main Content -->
    <main class="py-10">
        <div class="max-w-6xl mx-auto px-4">
            
            <!-- Results Bar -->
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-8 p-4 bg-white rounded-xl shadow-sm">
                <div class="text-gray-700">
                    <span class="font-bold text-purple-600 text-lg">{{ product_count }}</span> productos
                </div>
                <div class="flex items-center gap-3">
                    <label class="text-sm text-gray-500">Ordenar:</label>
                    <select id="sort-select" onchange="updateSort(this.value)"
                            class="px-4 py-2 border-2 border-gray-200 rounded-lg text-sm focus:outline-none focus:border-purple-500 transition-colors">
                        <option value="featured" {% if sort_by == 'featured' %}selected{% endif %}>Destacados</option>
                        <option value="price_low" {% if sort_by == 'price_low' %}selected{% endif %}>Menor precio</option>
                        <option value="price_high" {% if sort_by == 'price_high' %}selected{% endif %}>Mayor precio</option>
                        <option value="newest" {% if sort_by == 'newest' %}selected{% endif %}>Más recientes</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Nombre A-Z</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" id="products-container">
                {% for product in products %}
                <article class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-all group"
                         data-product-id="{{ product.id }}"
                         data-product-slug="{{ product.slug }}"
                         data-base-image="{% if product.base_image_url %}{{ product.base_image_url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}">
                    
                    <!-- Badges -->
                    <div class="relative">
                        {% if product.is_new %}
                        <span class="absolute top-3 left-3 z-10 px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">Nuevo</span>
                        {% endif %}
                        {% if product.discount_percentage %}
                        <span class="absolute top-3 right-3 z-10 px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">-{{ product.discount_percentage }}%</span>
                        {% endif %}
                        {% if product.is_bestseller %}
                        <span class="absolute top-3 {% if product.is_new %}left-20{% else %}left-3{% endif %} z-10 px-3 py-1 bg-yellow-400 text-yellow-900 text-xs font-bold rounded-full">⭐ Popular</span>
                        {% endif %}
                        
                        <!-- Product Image -->
                        <a href="#" class="block aspect-square overflow-hidden bg-gray-100"
                           onclick="event.preventDefault(); goToDetailWithColor(this.closest('article'))">
                            <img src="{% if product.base_image_url %}{{ product.base_image_url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}"
                                 alt="{{ product.name }}" 
                                 class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                                 id="product-img-{{ product.id }}">
                        </a>
                    </div>

                    <!-- Product Info -->
                    <div class="p-4">
                        {% if product.material %}
                        <span class="text-xs text-purple-600 font-medium uppercase tracking-wide">{{ product.material }}</span>
                        {% endif %}

                        <h3 class="font-bold text-gray-900 mt-1 mb-2 line-clamp-2 group-hover:text-purple-600 transition-colors">
                            <a href="#" onclick="event.preventDefault(); goToDetailWithColor(this.closest('article'))">
                                {{ product.name }}
                            </a>
                        </h3>

                        <!-- Color Swatches -->
                        {% with colors=product.available_colors.all %}
                        {% if colors %}
                        <div class="flex flex-wrap gap-1.5 justify-center my-3">
                            {% for color in colors %}
                            <span class="color-dot w-5 h-5 rounded-full cursor-pointer border-2 border-transparent hover:scale-125 transition-all"
                                  style="background-color: {{ color.hex_code }}; 
                                         box-shadow: 0 0 0 1px {% if color.hex_code|lower in '#ffffff,#f5f5f5,#ffff00,#fcfcfc,#fff' %}#ccc{% else %}rgba(0,0,0,0.1){% endif %};"
                                  title="{{ color.name }}"
                                  data-color-slug="{{ color.slug }}"
                                  data-product-id="{{ product.id }}"></span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% endwith %}

                        <!-- Price -->
                        <div class="flex items-baseline gap-2 justify-center mb-3">
                            {% if product.sale_price %}
                            <span class="text-sm text-gray-400 line-through">S/ {{ product.base_price }}</span>
                            <span class="text-lg font-bold text-red-600">S/ {{ product.sale_price }}</span>
                            {% else %}
                            <span class="text-sm text-gray-500">Desde</span>
                            <span class="text-lg font-bold text-purple-600">S/ {{ product.base_price|default:"25.00" }}</span>
                            {% endif %}
                        </div>

                        <!-- CTA Button -->
                        <a href="#" 
                           onclick="event.preventDefault(); goToDetailWithColor(this.closest('article'))"
                           class="block w-full py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-center font-semibold rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all">
                            Personalizar
                        </a>
                    </div>
                </article>
                {% empty %}
                <div class="col-span-full text-center py-16">
                    <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No hay productos disponibles</h3>
                    <p class="text-gray-500">Intenta con otros filtros o regresa más tarde.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </main>
</div>

<!-- Mobile Filter Button (if needed) -->
<button type="button" 
        class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-purple-600 text-white rounded-full shadow-xl flex items-center justify-center hover:bg-purple-700 transition-all z-40"
        id="mobile-filter-toggle">
    <i class="fas fa-filter"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Initialize color swatches
    document.querySelectorAll('article[data-product-id]').forEach(card => {
        const dots = card.querySelectorAll('.color-dot');
        const img = card.querySelector('img[id^="product-img-"]');
        const baseImage = card.dataset.baseImage;
        const productSlug = card.dataset.productSlug;
        
        if (!dots.length) return;
        
        // Fetch colors and set active state
        fetch(`/api/product/${productSlug}/colors/`)
            .then(r => r.json())
            .then(data => {
                if (data.colors && data.colors.length > 0) {
                    let matchingColor = null;
                    
                    for (const color of data.colors) {
                        if (color.image_url === baseImage) {
                            matchingColor = color.slug;
                            break;
                        }
                    }
                    
                    if (!matchingColor) {
                        matchingColor = data.colors[0].slug;
                        if (data.colors[0].image_url && img) {
                            img.src = data.colors[0].image_url;
                        }
                    }
                    
                    dots.forEach(dot => {
                        if (dot.dataset.colorSlug === matchingColor) {
                            dot.classList.add('active', 'ring-2', 'ring-purple-500', 'ring-offset-2');
                        }
                    });
                } else {
                    if (dots[0]) dots[0].classList.add('active', 'ring-2', 'ring-purple-500', 'ring-offset-2');
                }
            })
            .catch(() => {
                if (dots[0]) dots[0].classList.add('active', 'ring-2', 'ring-purple-500', 'ring-offset-2');
            });
    });

    // Color swatch click handler
    document.querySelectorAll('.color-dot').forEach(swatch => {
        swatch.addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            const card = this.closest('article');
            if (!card) return;

            // Remove active state from all dots in this card
            card.querySelectorAll('.color-dot').forEach(d => {
                d.classList.remove('active', 'ring-2', 'ring-purple-500', 'ring-offset-2');
            });
            this.classList.add('active', 'ring-2', 'ring-purple-500', 'ring-offset-2');

            const slug = card.dataset.productSlug;
            const colorSlug = this.dataset.colorSlug;
            const img = card.querySelector('img[id^="product-img-"]');

            if (!slug || !colorSlug || !img) return;

            // Load new image
            fetch(`/api/product/${slug}/colors/?color=${encodeURIComponent(colorSlug)}`)
                .then(r => r.json())
                .then(data => {
                    if (data.image) img.src = data.image;
                })
                .catch(() => {});
        });
    });
});

// Navigate to product detail with selected color
function goToDetailWithColor(card) {
    const productSlug = card.dataset.productSlug;
    const categorySlug = "{{ category.slug }}";
    const subcategorySlug = "{{ subcategory.slug }}";
    
    const activeSwatch = card.querySelector('.color-dot.active') || card.querySelector('.color-dot');
    const colorSlug = activeSwatch ? activeSwatch.dataset.colorSlug : '';
    
    window.location.href = `/${encodeURIComponent(categorySlug)}/${encodeURIComponent(subcategorySlug)}/${encodeURIComponent(productSlug)}/?color=${colorSlug}`;
}

function updateSort(value) {
    const url = new URL(window.location);
    url.searchParams.set('sort', value);
    window.location = url;
}
</script>
{% endblock %}
