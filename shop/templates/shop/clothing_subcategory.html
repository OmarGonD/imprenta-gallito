{% extends 'base.html' %}
{% load static %}

{% block title %}{{ subcategory.name }} | {{ category.name }} | Imprenta Gallito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clothing.css' %}">
<!-- Agregar estilos corregidos -->
<style>
/* COPIAR TODO EL CONTENIDO DE clothing_corrected.css AQUÍ */
/* O mejor aún, incluirlo como archivo separado */
</style>
{% endblock %}

{% block content %}
<div class="clothing-page">
    <!-- Hero Banner, Breadcrumb, Filter Sidebar... (sin cambios) -->
    
    <!-- Products Grid -->
    <div class="products-grid" id="products-container">
        {% for product in products %}
        <article class="product-card" data-product-id="{{ product.id }}">
            <!-- Badges -->
            {% if product.is_new %}
            <span class="badge badge-new">Nuevo</span>
            {% endif %}
            {% if product.discount_percentage %}
            <span class="badge badge-sale">-{{ product.discount_percentage }}%</span>
            {% endif %}
            {% if product.is_bestseller %}
            <span class="badge badge-best">Más vendido</span>
            {% endif %}

            <!-- ESTRUCTURA CORREGIDA DE IMÁGENES (SIN INLINE STYLES) -->
            <a href="{{ product.get_absolute_url }}" class="product-image-wrapper">
                <!-- Imagen principal (por defecto - VISIBLE) -->
                <img src="{% if product.base_image_url %}{{ product.base_image_url }}{% else %}{% static 'img/placeholder-product.png' %}{% endif %}"
                    alt="{{ product.name }}" 
                    class="product-image active-color"
                    data-color-slug="default">

                <!-- Imágenes por color (OCULTAS por CSS, no inline) -->
                {% for variant in product.color_variants.all %}
                    {% if variant.image %}
                    <img src="{{ variant.image.url }}" 
                        alt="{{ product.name }} en {{ variant.color.name }}"
                        class="product-image"
                        data-color-slug="{{ variant.color.slug }}">
                    {% endif %}
                {% endfor %}
            </a>

            <div class="product-info">
                <!-- Nombre del producto con nuevo tamaño -->
                <h3 class="product-name">
                    <a href="{{ product.get_absolute_url }}">{{ product.name }}</a>
                </h3>

                {% if product.short_description %}
                <p class="product-description">{{ product.short_description }}</p>
                {% endif %}

                <!-- Color Swatches con funcionalidad de clic -->
                <div class="product-colors">
                    {% for color in product.available_colors.all|slice:":6" %}
                    <span class="color-dot {% if forloop.first %}active{% endif %}" 
                        style="background-color: {{ color.hex_code }};"
                        title="{{ color.name }}" 
                        data-color-slug="{{ color.slug }}"
                        data-product-id="{{ product.id }}"
                        role="button"
                        tabindex="0"
                        aria-label="Ver producto en color {{ color.name }}"></span>
                    {% endfor %}
                    {% if product.available_colors.count > 6 %}
                    <span class="more-colors">+{{ product.available_colors.count|add:"-6" }}</span>
                    {% endif %}
                </div>

                <!-- Pricing -->
                <div class="product-pricing">
                    {% if product.sale_price %}
                    <span class="price-original">S/ {{ product.starting_price }}</span>
                    <span class="price-current">S/ {{ product.sale_price }}</span>
                    {% else %}
                    <span class="price-current">Desde S/ {{ product.starting_price }}</span>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="product-actions">
                    <a href="{% url 'shop:product_detail' category.slug subcategory.slug product.slug %}"
                        class="btn-customize">
                        <i class="fas fa-palette"></i>
                        Personalizar
                    </a>
                </div>
            </div>
        </article>
        {% empty %}
        <div class="no-products">
            <i class="fas fa-box-open"></i>
            <h3>No hay productos disponibles</h3>
            <p>No encontramos productos que coincidan con tus filtros.</p>
            <a href="{% url 'shop:clothing_subcategory' category.slug subcategory.slug %}"
                class="btn-customize">Ver todos los productos</a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Mobile Filter Button -->
<button type="button" class="mobile-filter-btn" id="mobile-filter-toggle">
    <i class="fas fa-filter"></i> Filtros
</button>

<!-- Mobile Filter Overlay -->
<div class="filter-overlay" id="filter-overlay"></div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // CAMBIO DE COLOR AL HACER CLIC EN SWATCH
   // CAMBIO DE COLOR AL HACER CLIC EN SWATCH - VERSIÓN ROBUSTA
    document.querySelectorAll('.color-dot').forEach(function(dot) {
        dot.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const colorSlug = this.getAttribute('data-color-slug');
            const productCard = this.closest('.product-card');
            if (!productCard) return;

            // 1. Actualizar swatch activo
            productCard.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            this.classList.add('active');

            // 2. Cambiar imagen: Remover active-color de todas, agregar a la seleccionada
            const wrapper = productCard.querySelector('.product-image-wrapper');
            if (!wrapper) return;

            wrapper.querySelectorAll('.product-image').forEach(img => {
                img.classList.remove('active-color');
            });

            const targetImage = wrapper.querySelector(`.product-image[data-color-slug="${colorSlug}"]`);
            if (targetImage) {
                targetImage.classList.add('active-color');
            } else {
                // Si no existe imagen para ese color, volver a la principal
                wrapper.querySelector('.product-image[data-color-slug="default"]').classList.add('active-color');
            }
        });

        // Accesibilidad: Enter y Espacio
        dot.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });

    // Prevenir navegación accidental al clic en color dot
    document.querySelectorAll('.product-image-wrapper').forEach(wrapper => {
        wrapper.addEventListener('click', function(e) {
            if (e.target.closest('.color-dot')) {
                e.preventDefault();
                return false;
            }
        });
    });

    // Prevenir navegación al hacer clic en color dot
    document.querySelectorAll('.product-image-wrapper').forEach(wrapper => {
        wrapper.addEventListener('click', function(e) {
            if (e.target.closest('.color-dot')) {
                e.preventDefault();
            }
        });
    });

    // ===== RESTO DEL CÓDIGO (sin cambios) =====
    
    // Toggle filter sections
    document.querySelectorAll('.filter-title').forEach(function(title) {
        title.addEventListener('click', function() {
            const target = this.getAttribute('data-toggle');
            const content = document.getElementById('filter-' + target);
            const icon = this.querySelector('i');

            if (content) {
                content.classList.toggle('collapsed');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
        });
    });

    // Price presets
    document.querySelectorAll('.price-preset').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const minInput = document.querySelector('input[name="price_min"]');
            const maxInput = document.querySelector('input[name="price_max"]');

            minInput.value = this.getAttribute('data-min');
            maxInput.value = this.getAttribute('data-max');

            document.querySelectorAll('.price-preset').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Mobile filter toggle
    const mobileFilterBtn = document.getElementById('mobile-filter-toggle');
    const filterSidebar = document.querySelector('.filter-sidebar');
    const filterOverlay = document.getElementById('filter-overlay');

    if (mobileFilterBtn) {
        mobileFilterBtn.addEventListener('click', function() {
            filterSidebar.classList.toggle('open');
            filterOverlay.classList.toggle('active');
        });
    }

    if (filterOverlay) {
        filterOverlay.addEventListener('click', function() {
            filterSidebar.classList.remove('open');
            filterOverlay.classList.remove('active');
        });
    }

    // View toggle
    document.querySelectorAll('.view-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const view = this.getAttribute('data-view');
            const container = document.getElementById('products-container');

            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            container.classList.remove('grid-view', 'list-view');
            container.classList.add(view + '-view');
        });
    });
});

function updateSort(value) {
    const url = new URL(window.location);
    url.searchParams.set('sort', value);
    window.location = url;
}
</script>
{% endblock %}

<!--
════════════════════════════════════════════════════════════════
NOTAS IMPORTANTES PARA IMPLEMENTACIÓN EN DJANGO
════════════════════════════════════════════════════════════════

1. MODELO RECOMENDADO PARA VARIANTES DE COLOR:

class ProductColorVariant(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name='color_variants')
    color = models.ForeignKey(Color, on_delete=models.CASCADE)
    image = models.ImageField(upload_to='products/colors/', blank=True, null=True)
    stock = models.IntegerField(default=0)
    
    class Meta:
        unique_together = ('product', 'color')
    
    def __str__(self):
        return f"{self.product.name} - {self.color.name}"

2. EN LA VISTA (views.py):

def clothing_subcategory(request, category_slug, subcategory_slug):
    # ... tu código existente ...
    
    # Asegurar que los productos incluyan sus variantes de color
    products = products.prefetch_related(
        'color_variants__color',
        'available_colors'
    )
    
    return render(request, 'clothing_subcategory.html', {
        'products': products,
        # ... resto del contexto ...
    })

3. SI NO TIENES IMÁGENES POR COLOR:
   - Usa la "Opción 2" del JavaScript (carga dinámica)
   - O simplemente marca visualmente el color activo sin cambiar imagen
   - El código funcionará igual, solo no cambiará la imagen

4. ALTERNATIVA SIMPLE (SIN IMÁGENES POR COLOR):
   Si solo quieres marcar el color activo visualmente sin cambiar imagen,
   elimina todo el código de cambio de imagen y deja solo:
   
   productCard.querySelectorAll('.color-dot').forEach(d => {
       d.classList.remove('active');
   });
   this.classList.add('active');

════════════════════════════════════════════════════════════════
-->
