{% extends 'base.html' %}
{% load static %}

{% block title %}{{ subcategory.name }} | {{ category.name }} | Imprenta Gallito{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/clothing.css' %}">
<!-- Agregar estilos corregidos -->
{% endblock %}

{% block content %}
<div class="clothing-page">
    <!-- Hero Banner, Breadcrumb, Filter Sidebar... (sin cambios) -->
    
    <!-- Products Grid -->
    <div class="products-grid" id="products-container">
        {% for item in products_with_images %}
        {% with product=item.product images_by_color=item.images_by_color %}
        <article class="product-card" data-product-slug="{{ product.slug }}">
            <!-- Badges -->
            {% if product.is_new %}<span class="badge badge-new">Nuevo</span>{% endif %}
            {% if product.is_bestseller %}<span class="badge badge-best">Más vendido</span>{% endif %}

            <!-- IMAGEN QUE CAMBIA -->
            <a href="{{ product.get_absolute_url }}" class="product-image-wrapper">
                <img src="{{ product.base_image_url }}" 
                    alt="{{ product.name }}"
                    class="product-image primary active-color"
                    id="img-{{ product.slug }}">
            </a>

            <div class="product-info">
                <h3 class="product-name">
                    <a href="{{ product.get_absolute_url }}">{{ product.name }}</a>
                </h3>

                <!-- COLOR SWATCHES -->
                <div class="product-colors">
                    {% for color in product.available_colors.all|slice:":6" %}
                    <span class="color-dot {% if forloop.first %}active{% endif %}"
                        style="background-color: {{ color.hex_code }};"
                        data-color-slug="{{ color.slug }}"
                        data-product-slug="{{ product.slug }}"
                        title="{{ color.name }}"></span>
                    {% endfor %}
                    {% if product.available_colors.count > 6 %}
                    <span class="more-colors">+{{ product.available_colors.count|add:"-6" }}</span>
                    {% endif %}
                </div>

                <!-- Precio y botón -->
                <div class="product-pricing">
                    <span class="price-current">Desde S/ {{ product.starting_price }}</span>
                </div>
                <div class="product-actions">
                    <a href="{{ product.get_absolute_url }}" class="btn-customize">
                        Personalizar
                    </a>
                </div>
            </div>
        </article>
        {% endwith %}
        {% endfor %}
    </div>
</div>

<!-- Mobile Filter Button -->
<button type="button" class="mobile-filter-btn" id="mobile-filter-toggle">
    <i class="fas fa-filter"></i> Filtros
</button>

<!-- Mobile Filter Overlay -->
<div class="filter-overlay" id="filter-overlay"></div>
{% endblock %}

{% block extra_js %}
<script>
// JavaScript ultra simple y funcional - igual que en el detalle, pero usando TU API
document.addEventListener('DOMContentLoaded', function () {

    // Al hacer clic en un color dot
    document.querySelectorAll('.color-dot').forEach(function(dot) {
        dot.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const colorSlug = this.dataset.colorSlug;
            const productSlug = this.closest('.product-card').dataset.productSlug;
            const img = document.getElementById('img-' + productSlug);

            if (!img || !productSlug || !colorSlug) return;

            // 1. Cambiar swatch activo
            this.closest('.product-colors').querySelectorAll('.color-dot').forEach(d => {
                d.classList.remove('active');
            });
            this.classList.add('active');

            // 2. Llamar a tu API existente (la misma que usas en el detalle)
            fetch(`/api/product/${productSlug}/colors/?color=${colorSlug}`)
                .then(response => response.json())
                .then(data => {
                    if (data.image) {
                        // Animación suave
                        img.style.opacity = '0.4';
                        setTimeout(() => {
                            img.src = data.image;
                            img.style.opacity = '1';
                        }, 180);
                    }
                })
                .catch(err => {
                    console.warn('No hay imagen para este color, se mantiene la base', err);
                    // Opcional: volver a imagen base
                    img.src = img.dataset.baseUrl;
                });
        });
    });

    // Guardar URL base en data-attribute para fallback
    document.querySelectorAll('.product-image.primary').forEach(img => {
        img.dataset.baseUrl = img.src;
    });

    // Prevenir navegación al hacer clic en el color
    document.querySelectorAll('.product-image-wrapper').forEach(wrapper => {
        wrapper.addEventListener('click', function(e) {
            if (e.target.closest('.color-dot')) {
                e.preventDefault();
            }
        });
    });

    // === TU CÓDIGO ORIGINAL DE FILTROS (sin cambios) ===
    // (Todo lo de filtros móviles, toggle, etc. lo mantienes igual)
    // ... aquí va el resto de tu JS original (mobile filter, sort, etc.)
});
</script>
{% endblock %}
