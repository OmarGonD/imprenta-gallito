{% extends 'base.html' %}
{% load static %}

{% block title %}Tarjetas de Presentación | Imprenta Gallito{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary: #0066cc;
    --primary-dark: #004999;
    --secondary: #e63946;
    --dark: #1a1a2e;
    --light-bg: #f8f9fa;
    --border-color: #e0e0e0;
}

.business-cards-page { background-color: var(--light-bg); }

/* HERO */
.bc-hero {
    background: linear-gradient(135deg, var(--dark) 0%, #16213e 100%);
    padding: 60px 0;
}
.bc-hero .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}
.bc-hero-content h1 {
    font-size: 2.8rem;
    font-weight: 800;
    color: white;
    margin-bottom: 20px;
}
.bc-hero-content p {
    font-size: 1.2rem;
    color: rgba(255,255,255,0.85);
    margin-bottom: 30px;
}
.bc-hero-cta {
    display: inline-flex;
    align-items: center;
    gap: 12px;
    background: var(--secondary);
    color: white;
    padding: 16px 32px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
}
.hero-features {
    display: flex;
    gap: 30px;
    margin-top: 30px;
}
.hero-feature {
    display: flex;
    align-items: center;
    gap: 10px;
    color: rgba(255,255,255,0.9);
}
.hero-feature i { color: #4ade80; }

/* BREADCRUMB */
.bc-breadcrumb {
    background: white;
    padding: 15px 0;
    border-bottom: 1px solid var(--border-color);
}
.bc-breadcrumb .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}
.bc-breadcrumb ol {
    display: flex;
    gap: 8px;
    list-style: none;
    margin: 0;
    padding: 0;
}
.bc-breadcrumb li:not(:last-child)::after {
    content: "/";
    margin-left: 8px;
    color: #999;
}
.bc-breadcrumb a { color: #666; text-decoration: none; }

/* SUBCATEGORY TABS */
.bc-subcategories {
    background: white;
    padding: 40px 0;
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 100;
}
.bc-subcategories .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}
.subcategories-title {
    text-align: center;
    margin-bottom: 25px;
}
.subcategories-title h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--dark);
    margin: 0;
}
.subcategories-title p {
    font-size: 0.9rem;
    color: #666;
    margin: 5px 0 0 0;
}
.subcategory-tabs {
    display: flex;
    justify-content: center;
    gap: 25px;
    flex-wrap: wrap;
}

/* TAB - clickeable via JS */
.subcategory-tab {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 25px 25px;
    background: var(--light-bg);
    border: 3px solid transparent;
    border-radius: 20px;
    color: #333;
    transition: all 0.3s ease;
    min-width: 200px;
    max-width: 260px;
    position: relative;
    cursor: pointer;
    user-select: none;
}
.subcategory-tab:hover {
    border-color: var(--primary);
    background: white;
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,102,204,0.15);
}
.subcategory-tab.active {
    border-color: var(--primary);
    background: white;
    box-shadow: 0 8px 30px rgba(0,102,204,0.25);
}
.subcategory-tab.active::after {
    content: '';
    position: absolute;
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid var(--primary);
}
.tab-hint {
    display: none;
    position: absolute;
    top: 10px;
    right: 10px;
    width: 26px;
    height: 26px;
    background: var(--secondary);
    border-radius: 50%;
    color: white;
    font-size: 0.85rem;
    align-items: center;
    justify-content: center;
}
.subcategory-tab.active .tab-hint { display: flex; }
.tab-image {
    width: 180px;
    height: 120px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tab-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
}
.tab-content { text-align: center; pointer-events: none; }
.tab-name {
    font-weight: 700;
    font-size: 1.15rem;
    color: var(--dark);
    display: block;
    pointer-events: none;
}
.subcategory-tab.active .tab-name { color: var(--primary); }
.tab-desc {
    font-size: 0.85rem;
    color: #888;
    display: block;
    pointer-events: none;
}

/* PRODUCTS */
.bc-materials { padding: 60px 0; }
.bc-materials .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}
.results-info {
    display: none;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 15px 20px;
    background: white;
    border-radius: 10px;
}
.results-info.show { display: flex; }
.results-count strong { color: var(--primary); }
.clear-filter {
    padding: 8px 16px;
    background: var(--light-bg);
    color: var(--secondary);
    border-radius: 20px;
    cursor: pointer;
    border: none;
}
.clear-filter:hover {
    background: var(--secondary);
    color: white;
}
.materials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 22px;
}
.material-card {
    background: white;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 4px 18px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
}
.material-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 35px rgba(0,0,0,0.15);
}
.material-card.hidden { display: none !important; }
.material-image {
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
}
.material-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.material-badge {
    position: absolute;
    top: 12px;
    left: 12px;
    background: var(--secondary);
    color: white;
    padding: 5px 12px;
    border-radius: 18px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}
.material-badge.deluxe { background: linear-gradient(135deg, #f59e0b, #d97706); }
.material-badge.premium { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
.material-content {
    padding: 18px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
}
.material-content h3 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--dark);
    margin-bottom: 6px;
}
.material-content p {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 12px;
    flex-grow: 1;
}
.material-price {
    display: flex;
    align-items: baseline;
    gap: 6px;
    margin-bottom: 12px;
}
.price-from { font-size: 0.75rem; color: #999; }
.price-value { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
.material-cta {
    display: block;
    text-align: center;
    padding: 10px;
    background: var(--primary);
    color: white;
    font-weight: 600;
    border-radius: 8px;
    margin-top: auto;
}
.no-products {
    grid-column: 1 / -1;
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 16px;
    display: none;
}
.no-products.show { display: block; }
.no-products i { font-size: 4rem; color: #ddd; display: block; margin-bottom: 20px; }
.no-products button {
    padding: 12px 24px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

/* COMPARE */
.bc-compare {
    padding: 60px 0;
    background: #f0f4f8;
}
.bc-compare .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}
.section-header { text-align: center; margin-bottom: 40px; }
.section-header h2 { font-size: 2rem; font-weight: 700; color: var(--dark); }
.compare-table {
    background: white;
    border-radius: 16px;
    overflow: hidden;
}
.compare-table table { width: 100%; border-collapse: collapse; }
.compare-table th, .compare-table td {
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
}
.compare-table th { background: var(--dark); color: white; }
.compare-table th:first-child, .compare-table td:first-child { text-align: left; }
.check-icon { color: #4ade80; }
.cross-icon { color: #f87171; }

/* FEATURES */
.bc-features { background: white; padding: 60px 0; }
.bc-features .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}
.features-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 30px;
}
.feature-item { text-align: center; padding: 30px 20px; }
.feature-icon {
    width: 70px;
    height: 70px;
    background: linear-gradient(135deg, var(--primary), #0088ff);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
}
.feature-icon i { font-size: 1.8rem; color: white; }

/* CTA */
.bc-final-cta {
    background: linear-gradient(135deg, var(--secondary) 0%, #c1121f 100%);
    padding: 60px 0;
    text-align: center;
}
.bc-final-cta .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 20px;
}
.bc-final-cta h2 { color: white; font-size: 2rem; margin-bottom: 15px; }
.bc-final-cta p { color: rgba(255,255,255,0.9); margin-bottom: 30px; }
.bc-final-cta .cta-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: white;
    color: var(--secondary);
    padding: 16px 40px;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
}

/* RESPONSIVE */
@media (max-width: 768px) {
    .subcategory-tabs { flex-direction: column; align-items: center; }
    .subcategory-tab { width: 100%; max-width: 320px; flex-direction: row; gap: 15px; padding: 15px; }
    .tab-image { margin-bottom: 0; width: 100px; height: 70px; }
    .tab-content { text-align: left; }
    .subcategory-tab.active::after { display: none; }
    .materials-grid { grid-template-columns: 1fr; }
    .features-grid { grid-template-columns: 1fr; }
    .results-info { flex-direction: column; gap: 10px; }
}
</style>
{% endblock %}

{% block content %}
<div class="business-cards-page">
    <!-- Hero -->
    <section class="bc-hero">
        <div class="container">
            <div class="bc-hero-content">
                <h1>Tarjetas de Presentación que Dejan Huella</h1>
                <p>Crea tarjetas profesionales que reflejen tu marca.</p>
                <a href="#materials" class="bc-hero-cta">
                    <i class="fas fa-magic"></i> Comenzar a Diseñar
                </a>
                <div class="hero-features">
                    <div class="hero-feature"><i class="fas fa-check-circle"></i><span>Envío gratis</span></div>
                    <div class="hero-feature"><i class="fas fa-check-circle"></i><span>Diseño gratis</span></div>
                    <div class="hero-feature"><i class="fas fa-check-circle"></i><span>5 días</span></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Breadcrumb -->
    <nav class="bc-breadcrumb">
        <div class="container">
            <ol>
                <li><a href="{% url 'shop:home' %}">Inicio</a></li>
                <li>Tarjetas de Presentación</li>
            </ol>
        </div>
    </nav>

    <!-- Subcategory Tabs -->
    <section class="bc-subcategories" id="filter-section">
        <div class="container">
            <div class="subcategories-title">
                <h3>Elige tu nivel de calidad</h3>
                <p>Haz clic en una categoría para filtrar • Clic de nuevo para ver todos</p>
            </div>
            
            <div class="subcategory-tabs">
                {% for sub in subcategories %}
                <div class="subcategory-tab" data-filter-slug="{{ sub.slug }}" data-filter-name="{{ sub.name }}">
                    <span class="tab-hint">✕</span>
                    <div class="tab-image">
                        {% if sub.image_url %}
                        <img src="{{ sub.image_url }}" alt="{{ sub.name }}">
                        {% else %}
                        <i class="fas fa-image" style="font-size: 2rem; color: #ccc;"></i>
                        {% endif %}
                    </div>
                    <div class="tab-content">
                        <span class="tab-name">{{ sub.name }}</span>
                        <span class="tab-desc">{{ sub.description|truncatewords:6 }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <!-- Products Grid -->
    <section class="bc-materials" id="materials">
        <div class="container">
            <div class="subcategories-title">
                <h3>Explora Nuestros Materiales</h3>
                <p>Cada material ofrece una experiencia táctil única</p>
            </div>
            
            <div class="results-info" id="filter-results">
                <span class="results-count">
                    Mostrando <strong id="visible-count">0</strong> productos en <strong id="active-filter-name"></strong>
                </span>
                <button class="clear-filter" id="btn-clear-filter" type="button">
                    <i class="fas fa-times"></i> Quitar filtro
                </button>
            </div>
            
            <div class="materials-grid" id="products-container">
                {% for product in products %}
                <a href="{{ product.get_absolute_url }}" class="material-card" data-product-subcategory="{{ product.subcategory.slug|default:'' }}">
                    <div class="material-image">
                        {% if product.base_image_url %}
                        <img src="{{ product.base_image_url }}" alt="{{ product.name }}">
                        {% else %}
                        <img src="{% static 'images/placeholder-card.jpg' %}" alt="{{ product.name }}">
                        {% endif %}
                        {% if product.subcategory %}
                        <span class="material-badge {{ product.subcategory.slug }}">{{ product.subcategory.name }}</span>
                        {% endif %}
                    </div>
                    <div class="material-content">
                        <h3>{{ product.name }}</h3>
                        <p>{{ product.description|truncatewords:15 }}</p>
                        <div class="material-price">
                            <span class="price-from">Desde</span>
                            <span class="price-value">S/ {{ product.get_base_price }}</span>
                        </div>
                        <span class="material-cta">Personalizar</span>
                    </div>
                </a>
                {% endfor %}
                
                <div class="no-products" id="empty-message">
                    <i class="fas fa-box-open"></i>
                    <h3>No hay productos</h3>
                    <p>No encontramos productos en esta categoría.</p>
                    <button type="button" id="btn-show-all">Ver todos</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Compare -->
    <section class="bc-compare">
        <div class="container">
            <div class="section-header"><h2>Compara Nuestras Opciones</h2></div>
            <div class="compare-table">
                <table>
                    <thead><tr><th>Característica</th><th>Estándar</th><th>Premium</th><th>Deluxe</th></tr></thead>
                    <tbody>
                        <tr><td>Grosor</td><td>300g</td><td>350g</td><td>400g+</td></tr>
                        <tr><td>Acabados</td><td>Mate, Brillante</td><td>+ Soft Touch</td><td>+ Foil, Relieve</td></tr>
                        <tr><td>Bordes pintados</td><td><i class="fas fa-times cross-icon"></i></td><td><i class="fas fa-times cross-icon"></i></td><td><i class="fas fa-check check-icon"></i></td></tr>
                        <tr><td>Precio desde</td><td><strong>S/ 25</strong></td><td><strong>S/ 45</strong></td><td><strong>S/ 75</strong></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Features -->
    <section class="bc-features">
        <div class="container">
            <div class="features-grid">
                <div class="feature-item"><div class="feature-icon"><i class="fas fa-truck"></i></div><h4>Envío Rápido</h4></div>
                <div class="feature-item"><div class="feature-icon"><i class="fas fa-palette"></i></div><h4>Diseño Gratis</h4></div>
                <div class="feature-item"><div class="feature-icon"><i class="fas fa-shield-alt"></i></div><h4>Garantía 100%</h4></div>
                <div class="feature-item"><div class="feature-icon"><i class="fas fa-headset"></i></div><h4>Soporte</h4></div>
            </div>
        </div>
    </section>

    <!-- CTA -->
    <section class="bc-final-cta">
        <div class="container">
            <h2>¿Listo para causar una gran impresión?</h2>
            <p>Únete a miles de profesionales</p>
            <a href="#materials" class="cta-btn"><i class="fas fa-rocket"></i> Crear Mi Tarjeta</a>
        </div>
    </section>
</div>

<!-- 
  SCRIPT INLINE PARA MÁXIMA PRIORIDAD
  Se ejecuta ANTES que cualquier otro script
-->
<script>
// IIFE para evitar conflictos
(function() {
    'use strict';
    
    var CURRENT_FILTER = '';
    
    function log(msg) {
        console.log('[FILTRO] ' + msg);
    }
    
    function showAll() {
        log('Mostrando todos');
        CURRENT_FILTER = '';
        
        document.querySelectorAll('.subcategory-tab').forEach(function(t) {
            t.classList.remove('active');
        });
        
        document.querySelectorAll('.material-card').forEach(function(c) {
            c.classList.remove('hidden');
        });
        
        var resultsEl = document.getElementById('filter-results');
        if (resultsEl) resultsEl.classList.remove('show');
        
        var emptyEl = document.getElementById('empty-message');
        if (emptyEl) emptyEl.classList.remove('show');
        
        window.history.pushState({}, '', window.location.pathname);
    }
    
    function filterBySlug(slug, name) {
        log('Filtrando: ' + slug);
        
        if (CURRENT_FILTER === slug) {
            showAll();
            return;
        }
        
        CURRENT_FILTER = slug;
        var count = 0;
        
        document.querySelectorAll('.subcategory-tab').forEach(function(t) {
            if (t.getAttribute('data-filter-slug') === slug) {
                t.classList.add('active');
            } else {
                t.classList.remove('active');
            }
        });
        
        document.querySelectorAll('.material-card').forEach(function(c) {
            if (c.getAttribute('data-product-subcategory') === slug) {
                c.classList.remove('hidden');
                count++;
            } else {
                c.classList.add('hidden');
            }
        });
        
        log('Visibles: ' + count);
        
        var countEl = document.getElementById('visible-count');
        if (countEl) countEl.textContent = count;
        
        var nameEl = document.getElementById('active-filter-name');
        if (nameEl) nameEl.textContent = name;
        
        var resultsEl = document.getElementById('filter-results');
        if (resultsEl) resultsEl.classList.add('show');
        
        var emptyEl = document.getElementById('empty-message');
        if (emptyEl) {
            if (count === 0) {
                emptyEl.classList.add('show');
            } else {
                emptyEl.classList.remove('show');
            }
        }
        
        window.history.pushState({filter: slug}, '', '?tier=' + slug);
    }
    
    function handleTabClick(e) {
        var tab = e.target.closest('.subcategory-tab');
        if (!tab) return;
        
        log('CLICK DETECTADO en tab');
        
        // DETENER TODO
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        
        var slug = tab.getAttribute('data-filter-slug');
        var name = tab.getAttribute('data-filter-name');
        
        filterBySlug(slug, name);
        
        return false;
    }
    
    // CAPTURAR EN FASE DE CAPTURA (antes que cualquier otro listener)
    document.addEventListener('click', handleTabClick, true);
    
    // También en DOMContentLoaded por si acaso
    document.addEventListener('DOMContentLoaded', function() {
        log('DOM Ready - Inicializando');
        
        // Botón limpiar
        var clearBtn = document.getElementById('btn-clear-filter');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showAll();
            }, true);
        }
        
        // Botón mostrar todos
        var showAllBtn = document.getElementById('btn-show-all');
        if (showAllBtn) {
            showAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showAll();
            }, true);
        }
        
        // Aplicar filtro inicial
        var params = new URLSearchParams(window.location.search);
        var initialTier = params.get('tier');
        if (initialTier) {
            var tab = document.querySelector('[data-filter-slug="' + initialTier + '"]');
            if (tab) {
                filterBySlug(initialTier, tab.getAttribute('data-filter-name'));
            }
        }
        
        log('Tabs: ' + document.querySelectorAll('.subcategory-tab').length);
        log('Productos: ' + document.querySelectorAll('.material-card').length);
    });
    
    // Popstate
    window.addEventListener('popstate', function() {
        var params = new URLSearchParams(window.location.search);
        var tier = params.get('tier');
        if (tier) {
            var tab = document.querySelector('[data-filter-slug="' + tier + '"]');
            if (tab) filterBySlug(tier, tab.getAttribute('data-filter-name'));
        } else {
            showAll();
        }
    });
    
    log('Script cargado');
})();
</script>
{% endblock %}

{% block extra_js %}
<!-- Vacío - el script está inline arriba para máxima prioridad -->
{% endblock %}
