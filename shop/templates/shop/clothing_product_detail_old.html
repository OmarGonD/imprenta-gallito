{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} - {{ category.name }} | {{ block.super }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- BREADCRUMB -->
    <nav class="mb-6" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-2 text-sm text-gray-600">
            <li><a href="/" class="hover:text-blue-600">Inicio</a></li>
            <li><span class="mx-2">/</span></li>
            <li><a href="{% url 'shop:clothing_category' %}" class="hover:text-blue-600">{{ product.category.name }}</a>
            </li>
            <li><span class="mx-2">/</span></li>
            <li>
                <a href="{% url 'shop:clothing_subcategory' product.category.slug product.subcategory.slug %}"
                    class="hover:text-blue-600">{{ product.subcategory.name }}</a>
            </li>
            <li><span class="mx-2">/</span></li>
            <li class="text-gray-900 font-medium">{{ product.name }}</li>
        </ol>
    </nav>

    <!-- PRODUCT GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">

        <!-- LEFT: IMAGE -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <img src="{{ product.base_image_url }}" alt="{{ product.name }}" class="w-full h-auto object-contain"
                style="max-height: 600px;">
        </div>

        <!-- RIGHT: PRODUCT INFO -->
        <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-4">{{ product.name }}</h1>

            {% if product.sku %}
            <p class="text-sm text-gray-500 mb-4">SKU: {{ product.sku }}</p>
            {% endif %}

            {% if product.short_description %}
            <p class="text-gray-700 mb-6">{{ product.short_description }}</p>
            {% endif %}

            <!-- PRICE -->
            <div class="mb-6">
                <p class="text-sm text-gray-600">Precio:</p>
                <p class="text-3xl font-bold text-blue-600">
                    S/ {{ safe_starting_price|floatformat:2 }}
                </p>
            </div>

            <hr class="my-6">

            <!-- FORM -->
            <form id="add-to-cart-form" method="POST" action="{% url 'carrito-de-compras:add_to_cart' product.slug %}">
                {% csrf_token %}

                <!-- COLOR -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Color: <span class="text-red-500">*</span>
                    </label>
                    <select name="color" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecciona un color</option>
                        <option value="Azul Marino">Azul Marino</option>
                        <option value="Azul Real">Azul Real</option>
                        <option value="Blanco">Blanco</option>
                        <option value="Carbon">Carbon</option>
                        <option value="Gris">Gris</option>
                        <option value="Negro">Negro</option>
                        <option value="Rojo">Rojo</option>
                    </select>
                </div>

                <!-- ============================================================
                 COLOR SWATCHES
                 ============================================================ -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-3">
                        Color:
                        <span id="selected-color-name" class="text-gray-900 font-semibold">
                            {{ selected_color.name|default:"Selecciona un color" }}
                        </span>
                    </label>

                    {% if available_colors %}
                    <div class="color-swatches-container flex flex-wrap gap-3">
                        {% for color in available_colors %}
                        <button type="button"
                            class="color-swatch {% if color.slug == selected_color_slug %}active{% endif %}"
                            data-color-slug="{{ color.slug }}" data-color-name="{{ color.name }}"
                            title="{{ color.name }}" style="background-color: {{ color.hex_code }};">
                            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"
                                stroke="white" stroke-width="3">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </button>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-gray-500 text-sm">No hay colores disponibles</p>
                    {% endif %}
                </div>

                <!-- TALLA -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Talla: <span class="text-red-500">*</span>
                    </label>
                    <select name="size" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecciona una talla</option>
                        <option value="XS">XS</option>
                        <option value="S">S</option>
                        <option value="M">M</option>
                        <option value="L">L</option>
                        <option value="XL">XL</option>
                        <option value="XXL">XXL</option>
                        <option value="XXXL">XXXL</option>
                    </select>
                </div>

                <!-- CANTIDAD -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad:</label>
                    <input type="number" name="quantity" value="1" min="1" max="10000" required
                        class="w-32 px-4 py-2 border border-gray-300 rounded-lg">
                </div>

                <!-- BUTTON -->
                <button type="submit"
                    class="w-full bg-blue-600 text-white font-semibold py-4 px-6 rounded-lg hover:bg-blue-700 transition-all">
                    ðŸ›’ AÃ±adir al Carrito
                </button>
            </form>

        </div>
    </div>
</div>

<script>
    document.getElementById('add-to-cart-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const button = this.querySelector('button[type="submit"]');
        const originalText = button.innerHTML;

        button.disabled = true;
        button.innerHTML = 'â³ Agregando...';

        fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… ${data.message}\n\nProducto: ${data.product_name}\nColor: ${data.color}\nTalla: ${data.size}\nCantidad: ${data.quantity}`);
                } else {
                    alert('âŒ ' + data.message);
                }
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
    });
</script>
{% endblock %}