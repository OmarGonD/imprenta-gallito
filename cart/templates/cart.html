{% extends 'base.html' %}
{% load static %}
{% load shop_extras %}
{% block metadesciption %}
This is the shopping Cart.
{% endblock %}
{% block title %}
Carrito de compras - Imprenta Gallito
{% endblock %}

{% block content %}

{% if not cart_items and not sample_items and not pack_items and not unitary_product_items %}

<!-- Empty Cart State -->
<div class="empty-cart-container">
    <div class="container">
        <div class="empty-cart-content">
            <div class="empty-cart-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <h1 class="empty-cart-title">Tu carrito está vacío</h1>
            <p class="empty-cart-text">¡No te preocupes! Tenemos muchos productos increíbles esperándote.</p>
            <a href="/stickers" class="btn-empty-cart">
                <i class="fas fa-arrow-left"></i> Explorar Productos
            </a>
        </div>
    </div>
</div>

{% else %}

<!-- Cart with Items -->
<div class="cart-page-container">
    <div class="container">
        
        <!-- Page Title -->
        <div class="cart-header">
            <h1 class="cart-title">
                <i class="fas fa-shopping-cart"></i> Tu Carrito de Compras
            </h1>
            <p class="cart-subtitle">Revisa tus productos antes de continuar</p>
        </div>

        <div class="row">
            <!-- Cart Items Column -->
            <div class="col-lg-8 mb-4">
                
                <!-- Cart Items Cards -->
                <div class="cart-items-section">
                    
                    {% for cart_item in cart_items %}
                    <div class="cart-item-card">
                        <div class="cart-item-image">
                            {% if cart_item.file_a %}
                                {% if cart_item.file_name_a|endswith:'.ai' %}
                                    <img src="/static/img/admin/adobe_illustrator_file_logo.png" alt="{{ cart_item.product.name }}">
                                {% else %}
                                    <img src="{{ cart_item.file_a.url }}" alt="{{ cart_item.product.name }}">
                                {% endif %}
                            {% else %}
                                <img src="{{ cart_item.product.image.url }}" alt="{{ cart_item.product.name }}">
                            {% endif %}
                        </div>
                        
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">{{ cart_item.product.name }}</h3>
                            <div class="cart-item-specs">
                                <span class="spec-item"><i class="fas fa-ruler-combined"></i> {{ cart_item.size }}</span>
                                <span class="spec-item"><i class="fas fa-hashtag"></i> {{ cart_item.quantity }} unidades</span>
                            </div>
                            {% if cart_item.file_a %}
                            <div class="cart-item-files">
                                <p class="file-name"><i class="fas fa-file"></i> {{ cart_item.file_name_a }}</p>
                                {% if cart_item.file_name_b %}
                                <p class="file-name"><i class="fas fa-file"></i> {{ cart_item.file_name_b }}</p>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="cart-item-price">
                            <p class="price-label">Precio:</p>
                            <p class="price-value">S/ {{ cart_item.sub_total }}</p>
                        </div>
                        
                        <div class="cart-item-actions">
                            <a href="{% url 'carrito_de_compras:full_remove' cart_item.id %}" class="btn-remove" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Sample Items -->
                    {% for sample_item in sample_items %}
                    <div class="cart-item-card">
                        <div class="cart-item-image">
                            {% if sample_item.file_a %}
                                <img src="{{ sample_item.file_a.url }}" alt="{{ sample_item.sample.name }}">
                            {% else %}
                                <img src="{{ sample_item.sample.image.url }}" alt="{{ sample_item.sample.name }}">
                            {% endif %}
                        </div>
                        
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">{{ sample_item.sample.name }}</h3>
                            <div class="cart-item-specs">
                                <span class="spec-item"><i class="fas fa-ruler-combined"></i> {{ sample_item.size }}</span>
                                {% if sample_item.sample.name == 'Sobre con muestras' %}
                                <span class="spec-item"><i class="fas fa-hashtag"></i> 05 stickers</span>
                                {% else %}
                                <span class="spec-item"><i class="fas fa-hashtag"></i> 02 stickers</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="cart-item-price">
                            <p class="price-label">Precio:</p>
                            <p class="price-value">S/ {{ sample_item.sub_total }}</p>
                        </div>
                        
                        <div class="cart-item-actions">
                            <a href="{% url 'carrito_de_compras:full_remove_sample' sample_item.id %}" class="btn-remove" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Pack Items -->
                    {% for pack_item in pack_items %}
                    <div class="cart-item-card {% if pack_item in packs_with_min_prices %}promo-item{% endif %}">
                        {% if pack_item in packs_with_min_prices %}
                        <div class="promo-badge">
                            <i class="fas fa-tag"></i> 3x2
                        </div>
                        {% endif %}
                        
                        <div class="cart-item-image">
                            {% if pack_item.file_a %}
                                <img src="{{ pack_item.file_a.url }}" alt="{{ pack_item.pack.name }}">
                            {% else %}
                                <img src="{{ pack_item.pack.image.url }}" alt="{{ pack_item.pack.name }}">
                            {% endif %}
                        </div>
                        
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">{{ pack_item.pack.name }}</h3>
                            <div class="cart-item-specs">
                                <span class="spec-item"><i class="fas fa-hashtag"></i> {{ pack_item.quantity }}</span>
                                {% if pack_item.size %}
                                <span class="spec-item"><i class="fas fa-ruler-combined"></i> {{ pack_item.size }}</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="cart-item-price">
                            <p class="price-label">Precio:</p>
                            <p class="price-value">S/ {{ pack_item.sub_total }}</p>
                        </div>
                        
                        <div class="cart-item-actions">
                            <a href="{% url 'carrito_de_compras:full_remove_pack' pack_item.id %}" class="btn-remove" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Unitary Product Items -->
                    {% for unitary_product_item in unitary_product_items %}
                    <div class="cart-item-card">
                        <div class="cart-item-image">
                            {% if unitary_product_item.file_a %}
                                <img src="{{ unitary_product_item.file_a.url }}" alt="{{ unitary_product_item.unitaryproduct.name }}">
                            {% else %}
                                <img src="{{ unitary_product_item.unitaryproduct.image.url }}" alt="{{ unitary_product_item.unitaryproduct.name }}">
                            {% endif %}
                        </div>
                        
                        <div class="cart-item-details">
                            <h3 class="cart-item-name">{{ unitary_product_item.unitaryproduct.name }}</h3>
                            <div class="cart-item-specs">
                                <span class="spec-item"><i class="fas fa-hashtag"></i> {{ unitary_product_item.quantity }}</span>
                                {% if unitary_product_item.size %}
                                <span class="spec-item"><i class="fas fa-ruler-combined"></i> {{ unitary_product_item.size }}</span>
                                {% endif %}
                            </div>
                            <p class="unit-price">Precio unitario: S/ {{ unitary_product_item.unitaryproduct.price }}</p>
                        </div>
                        
                        <div class="cart-item-price">
                            <p class="price-label">Total:</p>
                            <p class="price-value">S/ {{ unitary_product_item.sub_total }}</p>
                        </div>
                        
                        <div class="cart-item-actions">
                            <a href="{% url 'carrito_de_compras:full_remove_unitary_product' unitary_product_item.id %}" class="btn-remove" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}

                </div>

                <!-- Continue Shopping Button (Mobile) -->
                <div class="continue-shopping-mobile">
                    <a href="{% url 'shop:home' %}" class="btn-continue-shopping">
                        <i class="fas fa-arrow-left"></i> Seguir Comprando
                    </a>
                </div>

            </div>

            <!-- Order Summary Column -->
            <div class="col-lg-4">
                <div class="order-summary-sticky">
                    
                    <!-- Order Summary Card -->
                    <div class="order-summary-card">
                        <h2 class="summary-title">
                            <i class="fas fa-receipt"></i> Resumen del Pedido
                        </h2>
                        
                        <div class="summary-content">
                            <!-- Subtotal -->
                            <div class="summary-row">
                                <span class="summary-label">Subtotal:</span>
                                <span class="summary-value">S/ {{ total }}</span>
                            </div>

                            <!-- Shipping -->
                            {% if user.is_authenticated %}
                                {% if costo_despacho == 0 %}
                                <div class="summary-row">
                                    <span class="summary-label">Envío:</span>
                                    <span class="summary-value free-shipping">¡GRATIS!</span>
                                </div>
                                {% else %}
                                <div class="summary-row">
                                    <span class="summary-label">Envío:</span>
                                    <span class="summary-value">S/ {{ costo_despacho }}</span>
                                </div>
                                {% endif %}
                            {% else %}
                            <div class="summary-row">
                                <span class="summary-label">Envío:</span>
                                <span class="summary-value text-muted small">Regístrese para calcular</span>
                            </div>
                            {% endif %}

                            <!-- Coupon Discount -->
                            {% if descuento_por_cupon > 0 %}
                            <div class="summary-row discount-row">
                                <span class="summary-label">Cupón:</span>
                                <span class="summary-value discount">-S/ {{ descuento_por_cupon }}</span>
                            </div>
                            {% endif %}

                            <!-- 3x2 Discount -->
                            {% if packs_with_min_prices and descuento_packs_3x2 > 0 %}
                            <div class="summary-row discount-row">
                                <span class="summary-label">Descuento 3x2:</span>
                                <span class="summary-value discount">-S/ {{ descuento_packs_3x2 }}</span>
                            </div>
                            {% endif %}

                            <div class="summary-divider"></div>

                            <!-- Total -->
                            <div class="summary-row summary-total">
                                <span class="summary-label-total">Total a Pagar:</span>
                                {% if user.is_authenticated %}
                                <span class="summary-value-total">S/ {{ total_a_pagar }}</span>
                                {% else %}
                                <span class="summary-value-total">S/ {{ total }}</span>
                                {% endif %}
                            </div>

                            <!-- Coupon Input -->
                            <div class="coupon-section">
                                <label for="user_cupon" class="coupon-label">
                                    <i class="fas fa-ticket-alt"></i> ¿Tienes un cupón?
                                </label>
                                <div class="coupon-input-group">
                                    <input type="text" id="user_cupon" class="coupon-input" placeholder="Ingresa tu código">
                                    <button type="button" id="cuponButton" class="btn-apply-coupon">Aplicar</button>
                                </div>
                            </div>

                            <!-- Shipping Address -->
                            {% if user.is_authenticated %}
                            <div class="shipping-section">
                                <label for="ShippingAddress" class="shipping-label">
                                    <i class="fas fa-map-marker-alt"></i> Dirección de envío:
                                </label>
                                <select id="ShippingAddress" class="shipping-select">
                                    <option value="{{ request.user.profile.shipping_address1 }}" selected>
                                        {{ request.user.profile.shipping_address1 }}
                                    </option>
                                    <option value="{{ request.user.profile.shipping_address2 }}">
                                        {{ request.user.profile.shipping_address2 }}
                                    </option>
                                </select>
                            </div>
                            {% endif %}

                            <!-- Action Buttons -->
                            <div class="checkout-actions">
                                {% if user.is_authenticated and total > 0 %}
                                    <button id="depositButton" class="btn-checkout">
                                        <i class="fas fa-money-bill-wave"></i> Pagar con Efectivo
                                    </button>
                                    <a href="{% url 'shop:home' %}" class="btn-continue-desktop">
                                        <i class="fas fa-arrow-left"></i> Seguir Comprando
                                    </a>
                                {% elif user.is_authenticated and total == 0 %}
                                    <button id="depositButtonEmptyCart" class="btn-checkout" data-toggle="modal" data-target="#exampleModal">
                                        <i class="fas fa-money-bill-wave"></i> Pagar con Efectivo
                                    </button>
                                    <a href="{% url 'shop:home' %}" class="btn-continue-desktop">
                                        <i class="fas fa-arrow-left"></i> Seguir Comprando
                                    </a>
                                {% else %}
                                    <button id="depositButtonCannotbuy" class="btn-checkout" data-toggle="modal" data-target="#CannotbuyButtonModal">
                                        <i class="fas fa-money-bill-wave"></i> Pagar con Efectivo
                                    </button>
                                    <a href="{% url 'shop:home' %}" class="btn-continue-desktop">
                                        <i class="fas fa-arrow-left"></i> Seguir Comprando
                                    </a>
                                {% endif %}
                            </div>

                            <!-- Trust Badges -->
                            <div class="trust-badges">
                                <div class="trust-item">
                                    <i class="fas fa-lock"></i>
                                    <span>Pago Seguro</span>
                                </div>
                                <div class="trust-item">
                                    <i class="fas fa-shipping-fast"></i>
                                    <span>Envío Rápido</span>
                                </div>
                                <div class="trust-item">
                                    <i class="fas fa-medal"></i>
                                    <span>Calidad Garantizada</span>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>
</div>

{% endif %}

<!-- All Scripts -->
<script>
    $("#buyButton").hide();
    $("#EmptyCartButton").hide();
    $("#CannotbuyButton").hide();
    $(function () {
        $("input.pago-tarjeta[type='radio']").click(function () {
            if ($(this).is(':checked')) {
                $("#buyButton").fadeIn("slow");
                $("#EmptyCartButton").fadeIn("slow");
                $("#CannotbuyButton").fadeIn("slow");
                $("#depositButton").hide();
                $("#depositButtonEmptyCart").hide();
                $("#depositButtonCannotbuy").hide();
                $(".pago-deposito-detalle").hide();
            }
        });
    });

    $(function () {
        $("input.pago-deposito[type='radio']").click(function () {
            if ($(this).is(':checked')) {
                $("#depositButton").fadeIn("slow");
                $("#depositButtonEmptyCart").fadeIn("slow");
                $("#depositButtonCannotbuy").fadeIn("slow");
                $(".pago-deposito-detalle").show();
                $("#buyButton").hide();
                $("#EmptyCartButton").hide();
                $("#CannotbuyButton").hide();
            }
        });
    });

    $('#EmptyCartButton').on('click', function (e) {
        alert("Por favor, añada un pedido a su carrito de compras.");
        e.preventDefault();
    });

    $('#buyButton').on('click', function (e) {
        Culqi.open();
        e.preventDefault();
    });

    $('#depositButtonEmptyCart').on('click', function (e) {
        alert("Por favor, añada un pedido a su carrito de compras.");
        e.preventDefault();
    });

    $('#depositButton').on('click', function (e) {
        var shipping_address = $('#ShippingAddress').val()
        $.post("{% url 'carrito_de_compras:cart_charge_deposit_payment' %}", {
            payment_method: 'deposit_payment',
            amount: '{{ total_a_pagar }}',
            stickers_price: '{{ total }}',
            discount: '{{ descuento }}',
            currency_code: 'PEN',
            source_id: "10",
            last_four: 1111,
            shipping_cost: '{{ costo_despacho }}',
            shipping_address: shipping_address
        }).done(function () {
            window.location.href = "{% url 'order:thanks_deposit_payment' %}";
        });
    });

    $('#cuponButton').on('click', function (e) {
        var user_cupon = $('#user_cupon').val()
        $.post("{% url 'marketing:cupones' %}", {
            user_cupon: user_cupon,
        }).done(function () {
            window.location.href = "{% url 'carrito_de_compras:cart_detail' %}";
        })
    });
</script>

<!-- Modals -->
<div class="modal fade" id="CannotbuyButtonModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Regístrate</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Hola Gallito(a), recuerda que debes registrarte para poder realizar la compra.<br>
                Registrándote podrás ingresar la dirección a donde quieres que enviemos los productos.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="PayWithCashExplanation" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pagar con Efectivo</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Al dar click en esta opción nuestro sistema generará una orden con todos los productos que haya colocado en su carrito de compras.</p>
                <p>En pantalla se le mostrará: su número de orden, el total a pagar y las cuentas bancarias para hacer el depósito. También le enviaremos un correo con estos detalles.</p>
                <p>La fecha de entrega se coordinará con Ud. vía correo electrónico, una vez que cancele su orden.</p>
                <p>Recuerde que tendrá 48 horas para cancelar su orden, de lo contrario la misma será anulada en nuestro sistema.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="SeguirComprandoExplanation" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Seguir comprando</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Puede seguir comprando con total tranquilidad, los producto que ya agregó al carrito de compras permanecerán en él, incluso si regresa a otra sección de la página.</p>
                <p>Los productos se eliminarán del carrito de compras, solo si usted los elimina manualmente o si cierra su sesión.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
