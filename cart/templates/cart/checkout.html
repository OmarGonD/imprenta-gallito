{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Imprenta Gallito{% endblock %}

{% block content %}
<!-- Culqi V4 -->
<script src="https://checkout.culqi.com/js/v4"></script>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">
            <i class="fas fa-lock text-blue-600 mr-2"></i>Finalizar Compra
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Resumen de Orden -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Dirección de Envío -->
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-red-500"></i> Envío
                    </h2>
                    <p class="text-gray-600 font-medium">{{ user.profile.shipping_address1 }}</p>
                    <p class="text-gray-500 text-sm">
                        {{ user.profile.shipping_district }}, {{ user.profile.shipping_province }}, {{ user.profile.shipping_department }}
                    </p>
                    <p class="text-gray-500 text-sm mt-1">
                        <i class="fas fa-user mr-1"></i> {{ user.first_name }} {{ user.last_name }} ({{ user.profile.phone_number }})
                    </p>
                    <a href="{% url 'shop:profile_edit' %}" class="text-blue-600 text-sm hover:underline mt-2 inline-block">
                        Editar dirección
                    </a>
                </div>

                <!-- Método de Pago -->
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <i class="fas fa-credit-card text-blue-500"></i> Método de Pago
                    </h2>

                    <!-- Pestañas / Opciones -->
                    <div class="space-y-4">
                        <!-- Opción Tarjeta -->
                        <div class="border rounded-xl overflow-hidden hover:border-blue-500 transition-colors cursor-pointer group" onclick="selectPayment('card')">
                            <div class="p-4 flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center group-hover:bg-blue-100 transition-colors">
                                    <i class="fas fa-credit-card text-blue-600 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-900">Tarjeta de Crédito / Débito</h3>
                                    <p class="text-sm text-gray-500">Visa, Mastercard, Amex, Diners</p>
                                </div>
                                <div class="payment-radio w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <div class="w-3 h-3 rounded-full bg-blue-600 hidden" id="check-card"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Opción Transferencia -->
                        <div class="border rounded-xl overflow-hidden hover:border-blue-500 transition-colors cursor-pointer group" onclick="selectPayment('deposit')">
                            <div class="p-4 flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-50 rounded-full flex items-center justify-center group-hover:bg-green-100 transition-colors">
                                    <i class="fas fa-university text-green-600 text-xl"></i>
                                </div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-gray-900">Transferencia Bancaria / Yape</h3>
                                    <p class="text-sm text-gray-500">BCP, Interbank, Yape, Plin</p>
                                </div>
                                <div class="payment-radio w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center">
                                    <div class="w-3 h-3 rounded-full bg-blue-600 hidden" id="check-deposit"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Totales -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg border border-gray-100 sticky top-4">
                    <div class="p-6 bg-gray-50 border-b border-gray-100 rounded-t-xl">
                        <h3 class="font-bold text-gray-900">Resumen del Pedido</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between text-gray-600">
                            <span>Subtotal</span>
                            <span>S/ {{ total|floatformat:2 }}</span>
                        </div>
                        <div class="flex justify-between text-gray-600">
                            <span>Envío</span>
                            <span>S/ {{ costo_despacho|floatformat:2 }}</span>
                        </div>
                        {% if descuento_por_cupon > 0 %}
                        <div class="flex justify-between text-green-600">
                            <span>Descuento</span>
                            <span>- S/ {{ descuento_por_cupon|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="border-t pt-4 mt-4 flex justify-between items-center">
                            <span class="text-lg font-bold text-gray-900">Total</span>
                            <span class="text-2xl font-bold text-blue-600">S/ {{ total_a_pagar|floatformat:2 }}</span>
                        </div>

                        <button id="btn-pay" disabled
                            class="w-full py-4 mt-6 bg-gray-400 text-white font-bold rounded-xl shadow-lg transition-all transform disabled:cursor-not-allowed">
                            Selecciona Método de Pago
                        </button>
                        
                        <p class="text-xs text-gray-400 text-center mt-4">
                            Tus datos personales se utilizarán para procesar tu pedido y mejorar tu experiencia en la web.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Info Cuentas -->
<div id="depositModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="closeDepositModal()"></div>
    <div class="absolute inset-4 md:inset-[20%] flex items-center justify-center">
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8">
            <h3 class="text-2xl font-bold mb-4 text-center">Cuentas Bancarias</h3>
            <div class="space-y-4 text-sm text-gray-700 bg-gray-50 p-6 rounded-xl">
                <p><strong>BCP Soles:</strong> 193-xxxxxxxx-0-xx</p>
                <p><strong>Interbank:</strong> 200-xxxxxxxx-xx</p>
                <p><strong>Yape/Plin:</strong> 999 999 999</p>
                <p class="text-xs text-gray-500 mt-2">Titular: Imprenta Gallito SAC</p>
            </div>
            <p class="text-gray-600 mt-4 text-center">
                Al confirmar, tu pedido será registrado y nos pondremos en contacto para confirmar la transacción.
            </p>
            <div class="mt-8 flex gap-4">
                 <button onclick="closeDepositModal()" class="flex-1 py-3 bg-gray-100 rounded-lg font-bold text-gray-600">Cancelar</button>
                 <button onclick="processDeposit()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700">Confirmar Pedido</button>
            </div>
        </div>
    </div>
</div>

<!-- Form oculto para Culqi -->
<form id="culqi-form" method="POST" action="{% url 'carrito-de-compras:cart_charge_credit_card' %}">
    {% csrf_token %}
    <input type="hidden" name="payment_method" value="credit_card_payment">
    <input type="hidden" name="amount" value="{{ total_a_pagar|floatformat:0|add:'00' }}"> <!-- Culqi expects cents? Adjust based on view logic -->
    <!-- View expects 'amount' as integer cents for grid? No, view divides by 100 IF from charge. 
         Let's check view logic: amount = request.POST.get('amount') -> int(amount). 
         Then transaction_amount = int(charge['amount']) / 100.
         So we should pass total in CENTS to Culqi if creating charge manually?
         Wait, Culqi Checkout handles the token. We send the TOKEN to backend.
         Backend uses token to Charge.
         Backend expects: amount, currency_code, email, source_id (token), shipping info.
    -->
    <input type="hidden" name="currency_code" value="PEN">
    <input type="hidden" name="email" id="card_email" value="{{ user.email }}">
    <input type="hidden" name="source_id" id="culqi_token">
    <input type="hidden" name="shipping_cost" value="{{ costo_despacho }}">
    <input type="hidden" name="shipping_address" value="{{ user.profile.shipping_address1 }}">
</form>

<!-- Form oculto para Depósito -->
<form id="deposit-form" method="POST" action="{% url 'carrito-de-compras:cart_charge_deposit_payment' %}">
    {% csrf_token %}
    <input type="hidden" name="amount" value="{{ total_a_pagar }}">
    <input type="hidden" name="shipping_cost" value="{{ costo_despacho }}">
    <input type="hidden" name="shipping_address" value="{{ user.profile.shipping_address1 }}">
    <input type="hidden" name="comments" value="Pago con deposito/transferencia">
</form>

<script>
    Culqi.publicKey = "{{ culqi_public_key }}";
    
    // Configuración Culqi
    Culqi.options({
        style: {
            logo: "{% static 'media/gallito_logo.png' %}",
            maincolor: "#2563EB"
        }
    });

    // Forzar monto en céntimos para Culqi (si la librería lo usa por defecto)
    // Pero aquí configuramos Culqi settings
    Culqi.settings({
        title: 'Imprenta Gallito',
        currency: 'PEN', 
        description: 'Compra en Imprenta Gallito',
        amount: Math.round({{ total_a_pagar }} * 100)
    });

    let selectedMethod = null;

    function selectPayment(method) {
        selectedMethod = method;
        
        // Visual
        document.getElementById('check-card').classList.add('hidden');
        document.getElementById('check-deposit').classList.add('hidden');
        
        if (method === 'card') {
            document.getElementById('check-card').classList.remove('hidden');
        } else {
            document.getElementById('check-deposit').classList.remove('hidden');
        }

        // Btn
        const btn = document.getElementById('btn-pay');
        btn.disabled = false;
        btn.classList.remove('bg-gray-400');
        btn.classList.add('bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'hover:from-blue-700', 'hover:to-purple-700');
        btn.textContent = method === 'card' ? 'Pagar con Tarjeta' : 'Generar Orden de Transferencia';
        
        btn.onclick = function() {
            if (method === 'card') {
                Culqi.open();
            } else {
                document.getElementById('depositModal').classList.remove('hidden');
            }
        };
    }

    function closeDepositModal() {
        document.getElementById('depositModal').classList.add('hidden');
    }

    function processDeposit() {
        document.getElementById('deposit-form').submit();
    }

    // Handler de Culqi
    function culqi() {
        if (Culqi.token) { 
            // ¡Objeto Token creado exitosamente!
            const token = Culqi.token.id;
            const email = Culqi.token.email;
            
            document.getElementById('culqi_token').value = token;
            document.getElementById('card_email').value = email;
            
            // Send to backend
            document.getElementById('culqi-form').submit();
        } else { 
            // ¡Hubo algún problema!
            // Mostramos JSON de objeto error en consola
            console.log(Culqi.error);
            alert(Culqi.error.user_message);
        }
    };
</script>

{% endblock %}
